---
title: "Pakistan CCDR - 01. Climate and Development"
date: "03/11/2022"
output:
  github_document: default
  html_document: default
knit: (function(inputFile, encoding) {
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_format = "github_document");
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_format = "html_document",
                        output_dir=file.path(dirname(inputFile), "../html/"))                  
      })
---

This chapter will place Pakistan’s core development priorities and challenges in the context of climate change.  and assess the immediate and longer-term risks to sustainable and inclusive development from climate change. The assessment of Pakistan’s core development priorities will be placed in the context of the government’s development vision and revised NDCs, the draft World Bank’s Country Partnership Framework (CPF) and the Country Climate Action Plan (CCAP) for Pakistan. It will summarize the main sectoral, macro-fiscal and financial opportunities to address critical development needs while building climate resilience and reducing emissions, with a focus on synergistic short- and medium-term strategies that are urgent for sustainable and inclusive growth and poverty reduction while transitioning to a resilient and low carbon economy.


```{r, echo=FALSE, results='hide', message=FALSE}
source("../../styles/SAR_CCDR_style.R")
source("../../utils/CCDR_utils.R")
library(knitr)
library(dplyr)
library(tidyr)
library(tidyverse)
library(stringr)
library(ggplot2)
library(ggalt)
library(forcats)
library(png)
library(ggpubr)
library(ggrepel)
library(scales)
library(hrbrthemes)
library(viridis)
library(wbstats)
library(wbgcharts)
library(wbgmaps)
library(wbggeo)
library(readr)
library(readxl)
library(gtable)
library(grid)
library(lubridate)
library(extrafont)
library(zoo)
create_wbgref()
style = style_SAR_CCDR()
```





&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's economic growth compared with South Asia and lower-middle-income group

Data source: WDI

Indicators: NY.GDP.PCAP.PP.CD

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_economic_growth <- function() {

  # data
  df <- wb_data(
    indicator = c("NY.GDP.PCAP.PP.CD"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 1990,
    end_date = 2020
  )
  df <- df %>% 
    mutate(num_def = NY.GDP.PCAP.PP.CD) %>% 
    select(iso3c, country, date, num_def) 
  
  # chart
  color_list = c(
    "XN" = style$colors$neutral.dark,
    "SAS" = style$colors$neutral, 
    "PAK" = style$colors$blue)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = date, y = num_def, group = rev(iso3c), color = iso3c)) +
        geom_line(size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,0)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = df %>% filter(date == max(date)) %>% pull(num_def) %>% repel(gap=6),
            labels = df %>% filter(date == max(date)) %>% pull(country)
          )) +
        scale_color_manual(values = color_list) +
        style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan's economic growth compared with South Asia and lower-middle-income group",
    subtitle = "GDP per capita, PPP (current international $)",
    source = "Source: World Development Indicators (NY.GDP.PCAP.PP.CD)"
  )
}

fig_ch1_economic_growth()

figure_save_draft_png(fig_ch1_economic_growth(), style_SAR_CCDR, "../png/fig_ch1_economic_growth.png", height=2.6, width=3.2)

```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's economic growth compared with South Asia and lower-middle-income group

Data source: WDI

Indicators: NY.GDP.PCAP.PP.CD

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_economic_growth_var1 <- function() {

  # data
  df <- wb_data(
    indicator = c("NY.GDP.PCAP.PP.CD"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 1990,
    end_date = 2020
  )
  df <- df %>% 
    mutate(num_def = NY.GDP.PCAP.PP.CD) %>% 
    select(iso3c, country, date, num_def) 
  
  # chart
  color_list = c(
    "XN" = style$colors$red.light,
    "SAS" = style$colors$purple.light, 
    "PAK" = style$colors$navy)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = date, y = num_def, group = rev(iso3c), color = iso3c)) +
        geom_line(size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,0)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = df %>% filter(date == max(date)) %>% pull(num_def) %>% repel(gap=6),
            labels = df %>% filter(date == max(date)) %>% pull(country)
          ), 
          expand=c(0.25,0)) +
        scale_color_manual(values = color_list) +
        style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan's economic growth compared with South Asia and lower-middle-income group",
    subtitle = "GDP per capita, PPP (current international $)",
    source = "Source: World Development Indicators (NY.GDP.PCAP.PP.CD)"
  )
}

fig_ch1_economic_growth_var1()

figure_save_draft_png(fig_ch1_economic_growth_var1(), style_SAR_CCDR, "../png/fig_ch1_economic_growth_var1.png", height=2.6, width=3.2)

```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's poverty compared with South Asia and lower-middle-income group

Data source: WDI

Indicators: SI.POV.DDAY

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_poverty <- function() {

  # data
  df <- wb_data(
    indicator = c("SI.POV.DDAY"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 1990,
    end_date = 2020
  )
  df <- df %>% 
    mutate(poverty = SI.POV.DDAY) %>% 
    select(iso3c, country, date, poverty) 
  df.poverty <- df %>%
    group_by(iso3c) %>% 
    mutate(interp = na.approx(poverty, na.rm=FALSE))
  
  # chart
  color_list = c(
    "XN" = style$colors$neutral.dark,
    "SAS" = style$colors$neutral, 
    "PAK" = style$colors$blue)
  
  figure(
    data = df.poverty,
    plot = function(df.poverty, style = style_SAR_CCDR()) {
      ggplot(df.poverty, aes(x = date, group = rev(iso3c), color = iso3c)) +
        geom_point(aes(y = poverty)) +
        geom_line(aes(y = interp), size = style$linesize/2, linetype = "dotted") +
        geom_line(aes(y = poverty), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,1)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = c(4.4, 12.8),
            labels = c("Pakistan", "Lower middle income")
          )) +
        annotate("text", x = 2013, y = 35, label = "South Asia", size = 2.5, family = style$family, color = style$colors$text) +
        scale_color_manual(values = color_list) +
        style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan's poverty compared with South Asia and lower-middle-income group",
    subtitle = "Poverty headcount ratio at $1.90 a day (2011 PPP)",
    source = "Source: World Development Indicators (SI.POV.DDAY)"
  )
}

fig_ch1_poverty()

figure_save_draft_png(fig_ch1_poverty(), style_SAR_CCDR, "../png/fig_ch1_poverty.png", height=2.6, width=3.2)

```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's poverty compared with South Asia and lower-middle-income group

Data source: WDI

Indicators: SI.POV.DDAY

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_poverty_var1 <- function() {

  # data
  df <- wb_data(
    indicator = c("SI.POV.DDAY"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 1990,
    end_date = 2020
  )
  df <- df %>% 
    mutate(poverty = SI.POV.DDAY) %>% 
    select(iso3c, country, date, poverty) 
  df.poverty <- df %>%
    group_by(iso3c) %>% 
    mutate(interp = na.approx(poverty, na.rm=FALSE))
  
  # chart
  color_list = c(
    "XN" = style$colors$red.light,
    "SAS" = style$colors$purple.light, 
    "PAK" = style$colors$navy)
  
  figure(
    data = df.poverty,
    plot = function(df.poverty, style = style_SAR_CCDR()) {
      ggplot(df.poverty, aes(x = date, group = rev(iso3c), color = iso3c)) +
        geom_point(aes(y = poverty)) +
        geom_line(aes(y = interp), size = style$linesize/2, linetype = "dotted") +
        geom_line(aes(y = poverty), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,1)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = c(4.4, 12.8),
            labels = c("Pakistan", "Lower middle income")
          ), 
          expand=c(0.1,0)) +
        annotate("text", x = 2013, y = 35, label = "South Asia", size = 2.5, family = style$family, color = style$colors$text) +
        scale_color_manual(values = color_list) +
        style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan's poverty compared with South Asia and lower-middle-income group",
    subtitle = "Poverty headcount ratio at $1.90 a day (2011 PPP)",
    source = "Source: World Development Indicators (SI.POV.DDAY)"
  )
}

fig_ch1_poverty_var1()

figure_save_draft_png(fig_ch1_poverty_var1(), style_SAR_CCDR, "../png/fig_ch1_poverty_var1.png", height=2.6, width=3.2)

```




&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's poverty compared with South Asia and lower-middle-income group

Data source: WDI

Indicators: SI.POV.LMIC

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_poverty_var2 <- function() {

  # data
  df <- wb_data(
    indicator = c("SI.POV.LMIC"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 1990,
    end_date = 2020
  )
  df <- df %>% 
    mutate(poverty = SI.POV.LMIC) %>% 
    select(iso3c, country, date, poverty) 
  df.poverty <- df %>%
    group_by(iso3c) %>% 
    mutate(interp = na.approx(poverty, na.rm=FALSE))
  
  # chart
  color_list = c(
    "XN" = style$colors$neutral.dark,
    "SAS" = style$colors$neutral, 
    "PAK" = style$colors$blue)
  
  figure(
    data = df.poverty,
    plot = function(df.poverty, style = style_SAR_CCDR()) {
      ggplot(df.poverty, aes(x = date, group = rev(iso3c), color = iso3c)) +
        geom_point(aes(y = poverty)) +
        geom_line(aes(y = interp), size = style$linesize/2, linetype = "dotted") +
        geom_line(aes(y = poverty), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,1)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = c(38, 32),
            labels = c("Pakistan", "Lower middle income")
          ), 
          expand=c(0.1,0)) +
        annotate("text", x = 2013, y = 75, label = "South Asia", size = 2.5, family = style$family, color = style$colors$text) +
        scale_color_manual(values = color_list) +
        style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan's poverty compared with South Asia and lower-middle-income group",
    subtitle = "Poverty headcount ratio at $3.20 a day (2011 PPP)",
    source = "Source: World Development Indicators (SI.POV.LMIC)"
  )
}

fig_ch1_poverty_var2()

figure_save_draft_png(fig_ch1_poverty_var2(), style_SAR_CCDR, "../png/fig_ch1_poverty_var2.png", height=2.6, width=3.2)

```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's poverty compared with South Asia and lower-middle-income group

Data source: WDI

Indicators: SI.POV.LMIC

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_poverty_var3 <- function() {

  # data
  df <- wb_data(
    indicator = c("SI.POV.LMIC"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 1990,
    end_date = 2020
  )
  df <- df %>% 
    mutate(poverty = SI.POV.LMIC) %>% 
    select(iso3c, country, date, poverty) 
  df.poverty <- df %>%
    group_by(iso3c) %>% 
    mutate(interp = na.approx(poverty, na.rm=FALSE))
  
  # chart
  color_list = c(
    "XN" = style$colors$red.light,
    "SAS" = style$colors$purple.light, 
    "PAK" = style$colors$navy)
  
  figure(
    data = df.poverty,
    plot = function(df.poverty, style = style_SAR_CCDR()) {
      ggplot(df.poverty, aes(x = date, group = rev(iso3c), color = iso3c)) +
        geom_point(aes(y = poverty)) +
        geom_line(aes(y = interp), size = style$linesize/2, linetype = "dotted") +
        geom_line(aes(y = poverty), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,1)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = c(38, 32),
            labels = c("Pakistan", "Lower middle income")
          ), 
          expand=c(0.1,0)) +
        annotate("text", x = 2013, y = 75, label = "South Asia", size = 2.5, family = style$family, color = style$colors$text) +
        scale_color_manual(values = color_list) +
        style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan's poverty compared with South Asia and lower-middle-income group",
    subtitle = "Poverty headcount ratio at $3.20 a day (2011 PPP)",
    source = "Source: World Development Indicators (SI.POV.LMIC)."
  )
}

fig_ch1_poverty_var3()

figure_save_draft_png(fig_ch1_poverty_var3(), style_SAR_CCDR, "../png/fig_ch1_poverty_var3.png", height=2.6, width=3.2)

```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's economic growth and poverty compared with South Asia and lower-middle-income group

Data source: WDI

Indicators: NY.GDP.PCAP.PP.CD, SI.POV.DDAY

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=6.5, out.width=800, dpi=200}

fig_ch1_economic_growth_and_poverty <- function() {

  # data
  df <- wb_data(
    indicator = c("NY.GDP.PCAP.PP.CD", "SI.POV.DDAY"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 1990,
    end_date = 2020
  )
  df <- df %>% 
    mutate(gdp = NY.GDP.PCAP.PP.CD) %>% 
    mutate(poverty = SI.POV.DDAY) %>% 
    select(iso3c, country, date, gdp, poverty)  %>%
    mutate(date = as.numeric(date))
  
  # chart
  color_list = c(
    "XN" = style$colors$neutral.dark,
    "SAS" = style$colors$neutral, 
    "PAK" = style$colors$blue)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.gdp <- df %>%
        select(iso3c, country, date, gdp) 
      
      p.gdp <- ggplot(df.gdp, aes(x = date, y = gdp, group = rev(iso3c), color = iso3c)) +
        geom_line(size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,0)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = df.gdp %>% filter(date == max(date)) %>% pull(gdp) %>% repel(gap=6),
            labels = df.gdp %>% filter(date == max(date)) %>% pull(country)
          )) +
        scale_color_manual(values = color_list) +
        labs(subtitle = "GDP per capita, PPP (current international $)")+
        style$theme()
      
      df.poverty <- df %>%
        select(iso3c, country, date, poverty) %>% 
        group_by(iso3c) %>% 
        mutate(interp = na.approx(poverty, na.rm=FALSE))
      
      p.poverty <- ggplot(df.poverty, aes(x = date, group = rev(iso3c), color = iso3c)) +
        geom_point(aes(y = poverty)) +
        geom_line(aes(y = interp), size = style$linesize/2, linetype = "dotted") +
        geom_line(aes(y = poverty), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,1)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = c(4.4, 12.8),
            labels = c("Pakistan", "Lower middle income")
          )) +
        annotate("text", x = 2013, y = 35, label = "South Asia", size = 2.5, family = style$family, color = style$colors$text) +
        scale_color_manual(values = color_list) +
        labs(subtitle = "Poverty headcount ratio at $1.90 a day (2011 PPP)")+
        style$theme()
      
      
      pt.gdp <- ggplotGrob(p.gdp)
      pt.poverty <- ggplotGrob(p.poverty)
  
      chart <- gtable_row(
        "chart", 
        list(pt.gdp, zeroGrob(), pt.poverty), 
        height = unit(1, "null"), 
        widths = unit.c(unit(1, "null"), unit(0.3, "in"), unit(1, "null"))
        )
      chart$theme <- style$theme()
      chart
      
    },
    aspect_ratio = 1,
    # title = "Pakistan's economic growth and poverty compared with South Asia and lower-middle-income group",
    source = "Source: World Development Indicators (NY.GDP.PCAP.PP.CD, SI.POV.DDAY)."
  )
}

fig_ch1_economic_growth_and_poverty()

figure_save_draft_png(fig_ch1_economic_growth_and_poverty(), style_SAR_CCDR, "../png/fig_ch1_economic_growth_and_poverty.png", height=2.6, width=6.5)

```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's economic growth and poverty compared with South Asia and lower-middle-income group

Data source: WDI

Indicators: NY.GDP.PCAP.PP.CD, SI.POV.DDAY

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=6.5, out.width=800, dpi=200}

fig_ch1_economic_growth_and_poverty_var1 <- function() {

  # data
  df <- wb_data(
    indicator = c("NY.GDP.PCAP.PP.CD", "SI.POV.DDAY"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 1990,
    end_date = 2020
  )
  df <- df %>% 
    mutate(gdp = NY.GDP.PCAP.PP.CD) %>% 
    mutate(poverty = SI.POV.DDAY) %>% 
    select(iso3c, country, date, gdp, poverty)  %>%
    mutate(date = as.numeric(date))
  
  # chart
  color_list = c(
    "XN" = style$colors$red.light,
    "SAS" = style$colors$purple.light, 
    "PAK" = style$colors$navy)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.gdp <- df %>%
        select(iso3c, country, date, gdp) 
      
      p.gdp <- ggplot(df.gdp, aes(x = date, y = gdp, group = rev(iso3c), color = iso3c)) +
        geom_line(size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,0)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = df.gdp %>% filter(date == max(date)) %>% pull(gdp) %>% repel(gap=6),
            labels = df.gdp %>% filter(date == max(date)) %>% pull(country)
          ), 
          expand=c(0.25,0)) +
        scale_color_manual(values = color_list) +
        labs(subtitle = "GDP per capita, PPP (current international $)")+
        style$theme()
      
      df.poverty <- df %>%
        select(iso3c, country, date, poverty) %>% 
        group_by(iso3c) %>% 
        mutate(interp = na.approx(poverty, na.rm=FALSE))
      
      p.poverty <- ggplot(df.poverty, aes(x = date, group = rev(iso3c), color = iso3c)) +
        geom_point(aes(y = poverty)) +
        geom_line(aes(y = interp), size = style$linesize/2, linetype = "dotted") +
        geom_line(aes(y = poverty), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,1)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = c(4.4, 12.8),
            labels = c("Pakistan", "Lower middle income")
          ), 
          expand=c(0.1,0)) +
        annotate("text", x = 2013, y = 35, label = "South Asia", size = 2.5, family = style$family, color = style$colors$text) +
        scale_color_manual(values = color_list) +
        labs(subtitle = "Poverty headcount ratio at $1.90 a day (2011 PPP)")+
        style$theme()
      
      
      pt.gdp <- ggplotGrob(p.gdp)
      pt.poverty <- ggplotGrob(p.poverty)
  
      chart <- gtable_row(
        "chart", 
        list(pt.gdp, zeroGrob(), pt.poverty), 
        height = unit(1, "null"), 
        widths = unit.c(unit(1, "null"), unit(0.3, "in"), unit(1, "null"))
        )
      chart$theme <- style$theme()
      chart
      
    },
    aspect_ratio = 1,
    # title = "Pakistan's economic growth and poverty compared with South Asia and lower-middle-income group",
    source = "Source: World Development Indicators (NY.GDP.PCAP.PP.CD, SI.POV.DDAY)."
  )
}

fig_ch1_economic_growth_and_poverty_var1()

figure_save_draft_png(fig_ch1_economic_growth_and_poverty_var1(), style_SAR_CCDR, "../png/fig_ch1_economic_growth_and_poverty_var1.png", height=2.6, width=6.5)

```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's economic growth and poverty compared with South Asia and lower-middle-income group, 2000-2020

Data source: WDI

Indicators: NY.GDP.PCAP.PP.CD, SI.POV.DDAY

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=6.5, out.width=800, dpi=200}

fig_ch1_economic_growth_and_poverty_var2 <- function() {

  # data
  df <- wb_data(
    indicator = c("NY.GDP.PCAP.PP.CD", "SI.POV.DDAY"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 2000,
    end_date = 2020
  )
  df <- df %>% 
    mutate(gdp = NY.GDP.PCAP.PP.CD) %>% 
    mutate(poverty = SI.POV.DDAY) %>% 
    select(iso3c, country, date, gdp, poverty)  %>%
    mutate(date = as.numeric(date))
  
  # chart
  color_list = c(
    "XN" = style$colors$red.light,
    "SAS" = style$colors$purple.light, 
    "PAK" = style$colors$navy)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.gdp <- df %>%
        select(iso3c, country, date, gdp) 
      
      p.gdp <- ggplot(df.gdp, aes(x = date, y = gdp, group = rev(iso3c), color = iso3c)) +
        geom_line(size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,0)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = df.gdp %>% filter(date == max(date)) %>% pull(gdp) %>% repel(gap=6),
            labels = df.gdp %>% filter(date == max(date)) %>% pull(country)
          ), 
          expand=c(0.25,0)) +
        scale_color_manual(values = color_list) +
        labs(subtitle = "GDP per capita, PPP (current international $)")+
        style$theme()
      
      df.poverty <- df %>%
        select(iso3c, country, date, poverty) %>% 
        group_by(iso3c) %>% 
        mutate(interp = na.approx(poverty, na.rm=FALSE))
      
      p.poverty <- ggplot(df.poverty, aes(x = date, group = rev(iso3c), color = iso3c)) +
        geom_point(aes(y = poverty)) +
        geom_line(aes(y = interp), size = style$linesize/2, linetype = "dotted") +
        geom_line(aes(y = poverty), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,1)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = c(3.6, 10.9),
            labels = c("Pakistan", "Lower middle income")
          ), 
          expand=c(0.1,0)) +
        annotate("text", x = 2014, y = 27, label = "South Asia", size = 2.5, family = style$family, color = style$colors$text) +
        scale_color_manual(values = color_list) +
        labs(subtitle = "Poverty headcount ratio at $1.90 a day (2011 PPP)")+
        style$theme()
      
      
      pt.gdp <- ggplotGrob(p.gdp)
      pt.poverty <- ggplotGrob(p.poverty)
  
      chart <- gtable_row(
        "chart", 
        list(pt.gdp, zeroGrob(), pt.poverty), 
        height = unit(1, "null"), 
        widths = unit.c(unit(1, "null"), unit(0.3, "in"), unit(1, "null"))
        )
      chart$theme <- style$theme()
      chart
      
    },
    aspect_ratio = 1,
    # title = "Pakistan's economic growth and poverty compared with South Asia and lower-middle-income group",
    source = "Source: World Development Indicators (NY.GDP.PCAP.PP.CD, SI.POV.DDAY)."
  )
}

fig_ch1_economic_growth_and_poverty_var2()

figure_save_draft_png(fig_ch1_economic_growth_and_poverty_var2(), style_SAR_CCDR, "../png/fig_ch1_economic_growth_and_poverty_var2.png", height=2.6, width=6.5)

```






&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Pakistan's economic growth and poverty compared with South Asia and lower-middle-income group, 2000-2020

Data source: WDI

Indicators: NY.GDP.PCAP.PP.CD, SI.POV.LMIC

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=2.6, fig.width=6.5, out.width=800, dpi=200}

fig_ch1_economic_growth_and_poverty_var3 <- function() {

  # data
  df <- wb_data(
    indicator = c("NY.GDP.PCAP.PP.CD", "SI.POV.LMIC"),
    country = c("PAK", "LMC", "SAS"),
    start_date = 2000,
    end_date = 2020
  )
  df <- df %>% 
    mutate(gdp = NY.GDP.PCAP.PP.CD) %>% 
    mutate(poverty = SI.POV.LMIC) %>% 
    select(iso3c, country, date, gdp, poverty)  %>%
    mutate(date = as.numeric(date))
  
  # chart
  color_list = c(
    "XN" = style$colors$red.light,
    "SAS" = style$colors$purple.light, 
    "PAK" = style$colors$navy)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.gdp <- df %>%
        select(iso3c, country, date, gdp) 
      
      p.gdp <- ggplot(df.gdp, aes(x = date, y = gdp, group = rev(iso3c), color = iso3c)) +
        geom_line(size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,0)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = df.gdp %>% filter(date == max(date)) %>% pull(gdp) %>% repel(gap=6),
            labels = df.gdp %>% filter(date == max(date)) %>% pull(country)
          ), 
          expand=c(0.25,0)) +
        scale_color_manual(values = color_list) +
        labs(subtitle = "GDP per capita, PPP (current international $)")+
        style$theme()
      
      df.poverty <- df %>%
        select(iso3c, country, date, poverty) %>% 
        group_by(iso3c) %>% 
        mutate(interp = na.approx(poverty, na.rm=FALSE))
      
      p.poverty <- ggplot(df.poverty, aes(x = date, group = rev(iso3c), color = iso3c)) +
        geom_point(aes(y = poverty)) +
        geom_line(aes(y = interp), size = style$linesize/2, linetype = "dotted") +
        geom_line(aes(y = poverty), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,1)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = c(34.4, 37.0, 52.6),
            labels = c("Pakistan", "Lower middle income", "South Asia")
          ), 
          expand=c(0.1,0)) +
        annotate("text", x = 2014, y = 27, label = "South Asia", size = 2.5, family = style$family, color = style$colors$text) +
        scale_color_manual(values = color_list) +
        labs(subtitle = "Poverty headcount ratio at $3.20 a day (2011 PPP)")+
        style$theme()
      
      
      pt.gdp <- ggplotGrob(p.gdp)
      pt.poverty <- ggplotGrob(p.poverty)
  
      chart <- gtable_row(
        "chart", 
        list(pt.gdp, zeroGrob(), pt.poverty), 
        height = unit(1, "null"), 
        widths = unit.c(unit(1, "null"), unit(0.3, "in"), unit(1, "null"))
        )
      chart$theme <- style$theme()
      chart
      
    },
    aspect_ratio = 1,
    # title = "Pakistan's economic growth and poverty compared with South Asia and lower-middle-income group",
    source = "Source: World Development Indicators (NY.GDP.PCAP.PP.CD, SI.POV.LMIC)."
  )
}

fig_ch1_economic_growth_and_poverty_var3()

figure_save_draft_png(fig_ch1_economic_growth_and_poverty_var3(), style_SAR_CCDR, "../png/fig_ch1_economic_growth_and_poverty_var3.png", height=2.6, width=6.5)

```







&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Population Pyramids of Pakistan in 2020, 2030, and 2050

Data source: https://population.un.org/wpp/Download/Probabilistic/Population/

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.7, fig.width=6.5, out.width=800, dpi=200}

fig_ch1_population_pyramid <- function() {
  
  # data
  df <- read_excel("../data/UN_PPP2019_Output_PopulationByAge_Female.xlsx", sheet="Median", skip=16)
  
  df_female <- df %>%
    rename(country = `Region, subregion, country or area *`) %>%
    rename(year = `...8`) %>%
    filter(country == "Pakistan") %>%
    filter(year == "2020" | year == "2030" | year == "2050") %>%
    select(`year`:`100+`) %>%
    mutate(sex = "female")
    
  df <- read_excel("../data/UN_PPP2019_Output_PopulationByAge_Male.xlsx", sheet="Median", skip=16)
  
  df_male <- df %>%
    rename(country = `Region, subregion, country or area *`) %>%
    rename(year = `...8`) %>%
    filter(country == "Pakistan") %>%
    filter(year == "2020" | year == "2030" | year == "2050") %>%
    select(`year`:`100+`) %>%
    mutate(sex = "male")
  
  df <- bind_rows(df_male, df_female) %>%
    gather(age_group, population, `0-4`:`100+`) %>%
    mutate(population = as.numeric(population))
  
  df$population <- ifelse(df$sex == "male", -1*df$population, df$population)
  
  age_group_order <- unique(df$age_group)
  
  # chart
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = factor(age_group, levels=age_group_order), y = population, fill = sex)) + 
        geom_bar(data = subset(df, sex == "female"), stat = "identity") +
        geom_bar(data = subset(df, sex == "male"), stat = "identity") + 
        scale_y_continuous(labels = paste0(as.character(c(seq(20, 0, -10), seq(10, 20, 10))), "m")) +
        coord_flip() +
        facet_grid(cols = vars(factor(year))) + 
        scale_fill_manual(
          values = c(
            male = style$colors$blue,
            female = style$colors$red)) +
        style$theme() +
          style$theme_legend("bottom") +
          theme(
            axis.text = element_blank(),
            panel.grid  = element_blank(),
            panel.grid.major.x = element_line(color = "gray50", size = 0.1,linetype = 3),
            strip.text.x = element_text(angle = 0, hjust = 0.5),
            panel.spacing = unit(0, "npc")
          )
    },
    # title = "Population Pyramids of Pakistan in 2020, 2030, and 2050",
    subtitle = "Population by age group and sex (million)",
    source = "Source: United Nations, Department of Economic and Social Affairs, Population Division. World Population Prospects: The 2019 Revision. (Medium variant)"
  )
}

fig_ch1_population_pyramid()

figure_save_draft_png(fig_ch1_population_pyramid(), style_SAR_CCDR, "../png/fig_ch1_population_pyramid.png", height=3.7, width=6.5)

```





&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Structure of ecomony in Pakistan

Data source: WDI

Indicators: "NV.AGR.TOTL.ZS", "NV.IND.TOTL.ZS", "NV.SRV.TOTL.ZS", "SL.AGR.EMPL.ZS", "SL.IND.EMPL.ZS", "SL.SRV.EMPL.ZS", "SL.AGR.EMPL.MA.ZS", "SL.IND.EMPL.MA.ZS", "SL.SRV.EMPL.MA.ZS", "SL.AGR.EMPL.FE.ZS", "SL.IND.EMPL.FE.ZS", "SL.SRV.EMPL.FE.ZS"

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=6.5, out.width=800, dpi=200}

fig_ch1_structure_of_economy <- function() {
  
# data
country_code = "PAK"
columns = c("iso2c", "iso3c", "country", "year", "Agriculture", "Industry", "Services")

indicators <- c("NV.AGR.TOTL.ZS", "NV.IND.TOTL.ZS", "NV.SRV.TOTL.ZS")
year <- 2020
df.nv <- wb_data(
  indicator = indicators,
  country = country_code,
  start_date = year,
  end_date = year
)

names(df.nv) = columns
for (x in colnames(df.nv)) attr(df.nv[[x]], "label") <- NULL
df.nv$indicator = "value added (% of GDP)"
 
indicators <- c("SL.AGR.EMPL.ZS", "SL.IND.EMPL.ZS", "SL.SRV.EMPL.ZS")
year <- 2019
df.empl <- wb_data(
  indicator = indicators,
  country = country_code,
  start_date = year,
  end_date = year
)

names(df.empl) = columns
for (x in colnames(df.empl)) attr(df.empl[[x]], "label") <- NULL
df.empl$indicator = "% of employment (modeled ILO estimate)"

indicators <- c("SL.AGR.EMPL.MA.ZS", "SL.IND.EMPL.MA.ZS", "SL.SRV.EMPL.MA.ZS")
year <- 2019
df.ma <- wb_data(
  indicator = indicators,
  country = country_code,
  start_date = year,
  end_date = year
)

names(df.ma) = columns
for (x in colnames(df.ma)) attr(df.ma[[x]], "label") <- NULL
df.ma$indicator = "% of male employment (modeled ILO estimate)"

indicators <- c("SL.AGR.EMPL.FE.ZS", "SL.IND.EMPL.FE.ZS", "SL.SRV.EMPL.FE.ZS")
year <- 2019
df.fe <- wb_data(
  indicator = indicators,
  country = country_code,
  start_date = year,
  end_date = year
)

names(df.fe) = columns
for (x in colnames(df.fe)) attr(df.fe[[x]], "label") <- NULL
df.fe$indicator = "% of female employment (modeled ILO estimate)"

df <- bind_rows(df.nv, df.empl, df.ma, df.fe) %>%
  gather(sector, value, c(Agriculture, Industry, Services)) %>%
  mutate(year = as.numeric(year))

# chart
indicator_levels = c("value added (% of GDP)", "% of employment (modeled ILO estimate)", "% of male employment (modeled ILO estimate)", "% of female employment (modeled ILO estimate)")
indicator_labels = c("value added (% of GDP)", "% of employment", "% of male employment", "% of female employment")
figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = "", y = value, fill = sector)) +
        geom_bar(width = 1, stat = "identity") +
        scale_fill_manual(values = c(
          Agriculture = style$colors$spot.secondary,
          Industry = style$colors$spot.primary.light,
          Services = style$colors$spot.primary
        )) +
        # geom_text(aes(y = ypos, label = sector), color = "white", size=2) +
        facet_grid(cols = vars(factor(indicator, levels=indicator_levels, labels=indicator_labels))) +
        # facet_grid(indicator ~ .) +
        # facet_grid(iso3c ~ ., labeller = as_labeller(str_wrap_lines(wbgref$regions$labels,3,force=TRUE))) + 
        coord_polar(theta = "y") +
        style$theme() +
        style$theme_legend("bottom") +
        theme(
          axis.text = element_blank(),
          panel.grid  = element_blank(),
          strip.text.x = element_text(angle = 0, hjust = 0.5),
          panel.spacing = unit(0, "npc")
        )
    },
    # title = "Structure of ecomony in Pakistan",
    subtitle = "Industry value added (2020) and employment breakdown (modeled ILO estimate, 2019)",
    source = "Source: World Development Indicators"
  )
}

fig_ch1_structure_of_economy()

figure_save_draft_png(fig_ch1_structure_of_economy(), style_SAR_CCDR, "../png/fig_ch1_structure_of_economy.png", height=3.1, width=6.5)
```




&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Structure of ecomony in Pakistan

Data source: WDI

Indicators: "NV.AGR.TOTL.ZS", "NV.IND.TOTL.ZS", "NV.SRV.TOTL.ZS", "SL.AGR.EMPL.ZS", "SL.IND.EMPL.ZS", "SL.SRV.EMPL.ZS", "SL.AGR.EMPL.MA.ZS", "SL.IND.EMPL.MA.ZS", "SL.SRV.EMPL.MA.ZS", "SL.AGR.EMPL.FE.ZS", "SL.IND.EMPL.FE.ZS", "SL.SRV.EMPL.FE.ZS"


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=6.5, out.width=800, dpi=200}

fig_ch1_structure_of_economy_var1 <- function() {
  
  # data
  country_code = "PAK"
  columns = c("iso2c", "iso3c", "country", "year", "Agriculture", "Industry", "Services")
  
  indicators <- c("NV.AGR.TOTL.ZS", "NV.IND.TOTL.ZS", "NV.SRV.TOTL.ZS")
  year <- 2020
  df.nv <- wb_data(
    indicator = indicators,
    country = country_code,
    start_date = year,
    end_date = year
  )
  
  names(df.nv) = columns
  for (x in colnames(df.nv)) attr(df.nv[[x]], "label") <- NULL
  df.nv$indicator = "value added (% of GDP)"
   
  indicators <- c("SL.AGR.EMPL.ZS", "SL.IND.EMPL.ZS", "SL.SRV.EMPL.ZS")
  year <- 2019
  df.empl <- wb_data(
    indicator = indicators,
    country = country_code,
    start_date = year,
    end_date = year
  )
  
  names(df.empl) = columns
  for (x in colnames(df.empl)) attr(df.empl[[x]], "label") <- NULL
  df.empl$indicator = "% of employment (modeled ILO estimate)"
  
  indicators <- c("SL.AGR.EMPL.MA.ZS", "SL.IND.EMPL.MA.ZS", "SL.SRV.EMPL.MA.ZS")
  year <- 2019
  df.ma <- wb_data(
    indicator = indicators,
    country = country_code,
    start_date = year,
    end_date = year
  )
  
  names(df.ma) = columns
  for (x in colnames(df.ma)) attr(df.ma[[x]], "label") <- NULL
  df.ma$indicator = "% of male employment (modeled ILO estimate)"
  
  indicators <- c("SL.AGR.EMPL.FE.ZS", "SL.IND.EMPL.FE.ZS", "SL.SRV.EMPL.FE.ZS")
  year <- 2019
  df.fe <- wb_data(
    indicator = indicators,
    country = country_code,
    start_date = year,
    end_date = year
  )
  
  names(df.fe) = columns
  for (x in colnames(df.fe)) attr(df.fe[[x]], "label") <- NULL
  df.fe$indicator = "% of female employment (modeled ILO estimate)"
  
  df <- bind_rows(df.nv, df.empl, df.ma, df.fe) %>%
    gather(sector, value, c(Agriculture, Industry, Services)) %>%
    mutate(year = as.numeric(year)) %>%
    arrange(desc(sector), desc(value)) %>%
    group_by(indicator) %>%
    mutate(pos = cumsum(value)- value/2)
  
  # chart
  color_list = c(
    Agriculture = style$colors$red,
    Industry = style$colors$orange,
    Services = style$colors$blue
  )
  
  indicator_levels = c("value added (% of GDP)", "% of employment (modeled ILO estimate)", "% of male employment (modeled ILO estimate)", "% of female employment (modeled ILO estimate)")
  indicator_labels = c("value added (% of GDP)", "% of employment", "% of male employment", "% of female employment")
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = factor(1), y = value, fill = sector)) +
        geom_bar(width = 1, stat = "identity", color = "white", size=1) +
        scale_fill_manual(values = color_list) +
        # geom_text(aes(y = ypos, label = sector), color = "white", size=2) +
        geom_text(aes(x= factor(1), y=pos, label = paste0(round(value), "%")), size=2.5, family=style$family) +
        facet_grid(cols = vars(factor(indicator, levels=indicator_levels, labels=indicator_labels))) +
        # facet_grid(indicator ~ .) +
        # facet_grid(iso3c ~ ., labeller = as_labeller(str_wrap_lines(wbgref$regions$labels,3,force=TRUE))) + 
        coord_polar(theta = "y") +
        style$theme() +
        style$theme_legend("bottom") +
        theme(
          panel.grid  = element_blank(),
          strip.text.x = element_text(angle = 0, hjust = 0.5),
          panel.spacing = unit(0, "npc"),
          axis.text = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_blank()
        )
    },
    # title = "Structure of ecomony in Pakistan",
    subtitle = "Industry value added (2020) and employment breakdown (modeled ILO estimate, 2019)",
    note = "Note: The value added shares presented in the World Development Indicators for agriculture, industry, and services may not always add up to a hundred percent due to financial intermediary services indirectly measured (FISIM) and net indirect taxes.",
    source = "Source: World Development Indicators"
  )
}

fig_ch1_structure_of_economy_var1()

figure_save_draft_png(fig_ch1_structure_of_economy_var1(), style_SAR_CCDR, "../png/fig_ch1_structure_of_economy_var1.png", height=3.1, width=6.5)
```




&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Total energy supply (TES)

Data source: https://www.iea.org/data-and-statistics/data-browser/?country=PAKISTAN&fuel=Energy%20supply&indicator=TESbySource

```{r, echo=FALSE, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_TES_share_by_source <- function() {
  
  # data
  df <- read_csv("../data/Total energy supply (TES) by source - Pakistan.csv", skip=4) %>%
    rename(year = X1) %>%
    select(-Units)
  df <- df %>%
    gather(source, TJ, 2:8) %>%
    group_by(year) %>%
    mutate(percentage =  100 *TJ/sum(TJ, na.rm=TRUE)) %>%
    mutate(year = as.numeric(year))
  
  ordered_source <- df %>%
    filter(year == 2019) %>%
    arrange(desc(percentage),source) %>% pull(source)
  
  # plot
  color_list <- c("Biofuels and waste" = "#45462A", 
                  "Natural gas" = "#227C9D", 
                  "Oil" = "#BCAA99", 
                  "Coal" = "#443850", 
                  "Nuclear" = "#8E5572", 
                  "Hydro" = "#3AAFB9", 
                  "Wind, solar, etc." = "#BBBE64")
  figure(
    data = df,
    plot = function(data, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = year, y = percentage, fill = factor(source, levels = ordered_source))) +
        geom_area() +
        style$theme() + 
        style$theme_legend("right") +
        scale_x_continuous(expand = c(0, 1)) +
        # scale_y_continuous(labels = millions()) +
        scale_fill_manual(values=color_list)
      },
      aspect_ratio = 1.5,
      # title = paste0("Biofuels and waste provide 33% of total energy supply, followed by natural gas, oil, and coal."),
      subtitle = "Total energy supply (TES) by source (%), 1990-2019",
      note = "Note: TES is made up of production + imports - exports - international marine bunkers - international aviation bunkers ± stock changes.",
      source = "Source: IEA World Energy Balances https://www.iea.org/data-and-statistics/data-product/world-energy-statistics-and-balances"
  )
}

fig_ch1_TES_share_by_source()

figure_save_draft_png(fig_ch1_TES_share_by_source(), style_SAR_CCDR, "../png/fig_ch1_TES_share_by_source.png", height=3.1, width=5.5)

```





&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Number of deaths and economic damages (% GDP) from natural disasters

Data source: https://ourworldindata.org/natural-disasters

Country: Pakistan

Disaster type: All disasters (by type)

Impact: Deaths, Economic damages (%GDP)

Timespan: Decadal average

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=4.1, fig.width=5.5, out.width=800, dpi=200}
fig_ch1_natural_disasters <- function() {
  
  # data
  df1 <- read_csv("../data/natural-disasters_pakistan_deaths.csv")
  names(df1) <- c('Entity', 'Code', 'Year', 'Extreme temperature', 'Wildfires', 'Storms', 
                  'Landslides', 'Mass movement (dry)', 'Volcanic activity', 'Earthquakes', 'Floods', 'Drought')
  df1 <- df1 %>%
    select(-c('Wildfires', 'Mass movement (dry)', 'Volcanic activity')) %>%
    gather(Type, Deaths, 4:9) %>%
    select(Year, Type, Deaths)
  
  df2 <- read_csv("../data/natural-disasters_pakistan_gdp.csv")
  names(df2) <- c('Entity', 'Code', 'Year', 'Extreme temperature', 'Wildfires', 'Storms', 
                  'Landslides', 'Mass movement (dry)', 'Volcanic activity', 'Earthquakes', 'Floods', 'Drought')
  df2 <- df2 %>%
    select(-c('Wildfires', 'Mass movement (dry)', 'Volcanic activity')) %>%
    gather(Type, Damage, 4:9) %>%
    mutate(Damage = Damage) %>%
    select(Year, Type, Damage)
  
  df <- merge(df1, df2, by=c("Year", "Type"))
  
  # chart
  figure(
    data =  df,
    plot = function(df, style = style_SAR_CCDR()) {
      p <- ggplot(df, aes(x=Year, y=reorder(Type, desc(Type)), size=ifelse(Damage==0, NA, Damage), color=Deaths, fill=Deaths)) +
        geom_point(alpha=0.5, shape=21, color="black") +
        scale_size(range = c(1, 20), name="Damage (%GDP)",
                   breaks = c(0.1, 0.5, 1),
                   labels = c("0.1", "0.5", "1")) +
        scale_fill_distiller(palette = "Spectral") + 
        scale_x_continuous(limits = c(1960, 2012), breaks = c(1960, 1970, 1980, 1990, 2000, 2010), labels = c("1960-1969", "1970-1979", "1980-1989", "1990-1999", "2000-2009", "2010-2019")) +
        xlab("Year") +
        ylab("Natural Disasters") +
        geom_curve(aes(x = 1990, y = 4.5, xend = 1997, yend = 5), 
                               colour = "#555555", 
                               size=0.3, 
                               curvature = -0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 1990, y = 4.3, label = "including 2005 Kashmir earthquake", size = 2.5, family = style$family) +
        geom_curve(aes(x = 1975, y = 1.5, xend = 1974, yend = 2.6), 
                               colour = "#555555", 
                               size=0.3, 
                               curvature = 0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 1975, y = 1.4, label = "including 1970 East Pakistan cyclone", size = 2.5, family = style$family) +
        geom_curve(aes(x = 2000, y = 2, xend = 2006, yend = 2.7), 
                               colour = "#555555", 
                               size=0.3, 
                               curvature = -0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 2000, y = 1.9, label = "including 2010 floods", size = 2.5, family = style$family) +
        style$theme() +
        theme(
          axis.title.x = element_text(vjust = -5),
          axis.title.y = element_text(angle = 90, vjust = 0, margin = margin(r = 15)),
          axis.text.x = element_text(angle = 0, vjust = 2), 
          legend.title = element_text(),
          legend.box.just = "center",
          legend.position = "right"
        )
    },
    aspect_ratio = 1,
    # title = "Floods and earthquakes are the most damaging natural disasters in Pakistan.",
    subtitle = "Decadal average: Number of deaths and economic damages (% GDP) from natural disasters",
    note = "Note: Decadal figures are measured as the annual average over the subsequent ten-year period.",
    source = "Source: Our World in Data."
  )
}

fig_ch1_natural_disasters()

figure_save_draft_png(fig_ch1_natural_disasters(), style_SAR_CCDR, "../png/fig_ch1_natural_disasters.png", height=4.1, width=5.5)
```




&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Number of deaths and economic damages (% GDP) from natural disasters

Data source: https://public.emdat.be/data

Variables: Deaths and economic damages

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=4.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disasters_var1 <- function() {
  
  # data
  GDP_2020 <- wb_data(
    indicator = c("NY.GDP.MKTP.CD"),
    country = c("PAK"),
    start_date = 2020,
    end_date = 2020
  )
  GDP_2020 <- GDP_2020$NY.GDP.MKTP.CD[1]
  
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 1960 & Year <= 2019) %>%
    mutate(Decade = as.numeric(paste0(substr(Year, 1, 3), '0'))) %>%
    rename(Group = `Disaster Subgroup`) %>%
    rename(Type = `Disaster Type`) %>%
    rename(Deaths = `Total Deaths`) %>%
    mutate(Damages = `Total Damages, Adjusted ('000 US$)`*1000/GDP_2020 * 100) %>%
    select(Decade, Group, Type, Deaths, Damages)
  
  df <- df %>%
    group_by(Decade, Type) %>%
      summarise(Frequency = n(),
                Deaths = sum(Deaths, na.rm=TRUE),
                Damages = sum(Damages, na.rm=TRUE),
                .groups = 'drop') %>%
    filter(Damages > 0)
  
  # chart
  figure(
    data =  df,
    plot = function(df, style = style_SAR_CCDR()) {
      p <- ggplot(df, aes(x=Decade, y=reorder(Type, desc(Type)), size=Damages, color=Deaths, fill=Deaths)) +
        geom_point(alpha=0.5, shape=21, color="black") +
        scale_size(range = c(1, 20), name="Damage (%GDP)",
                   breaks = c(1, 4, 8),
                   labels = c("1", "4", "8")) +
        scale_fill_distiller(palette = "Accent", direction=1) +
        scale_x_continuous(limits = c(1960, 2014), breaks = c(1960, 1970, 1980, 1990, 2000, 2010), labels = c("1960-1969", "1970-1979", "1980-1989", "1990-1999", "2000-2009", "2010-2019")) +
        xlab("Year") +
        ylab("Natural Disasters") +
        geom_curve(aes(x = 1990, y = 4.5, xend = 1997, yend = 5),
                               colour = "#555555",
                               size=0.3,
                               curvature = -0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 1990, y = 4.3, label = "including 2005 Kashmir earthquake", size = 2.5, family = style$family) +
        geom_curve(aes(x = 1975, y = 2, xend = 1973, yend = 2.8),
                               colour = "#555555",
                               size=0.3,
                               curvature = 0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 1975, y = 1.8, label = "including 1970 East Pakistan cyclone", size = 2.5, family = style$family) +
        geom_curve(aes(x = 2000, y = 1.8, xend = 2006, yend = 2.6),
                               colour = "#555555",
                               size=0.3,
                               curvature = -0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 2000, y = 1.6, label = "including 2010 floods", size = 2.5, family = style$family) +
        style$theme() +
        theme(
          axis.title.x = element_text(vjust = -5),
          axis.title.y = element_text(angle = 90, vjust = 0, margin = margin(r = 15)),
          axis.text.x = element_text(angle = 0, vjust = 2), 
          legend.title = element_text(),
          legend.box.just = "center",
          legend.position = "right"
        )
    },
    aspect_ratio = 1,
    # title = "Floods and earthquakes are the most damaging natural disasters in Pakistan.",
    subtitle = "Decadal sum: Number of deaths and economic damages (% GDP) from natural disasters",
    note = "Note: Decadal figures are measured as the annual sum over the subsequent ten-year period.",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disasters_var1()

figure_save_draft_png(fig_ch1_natural_disasters_var1(), style_SAR_CCDR, "../png/fig_ch1_natural_disasters_var1.png", height=4.1, width=5.5)

```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Number of people affected and economic damages (% GDP) from natural disasters

Data source: https://public.emdat.be/data

Variables: Affected and economic damages

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=4.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disasters_var2 <- function() {
  
  # data
  GDP_2020 <- wb_data(
    indicator = c("NY.GDP.MKTP.CD"),
    country = c("PAK"),
    start_date = 2020,
    end_date = 2020
  )
  GDP_2020 <- GDP_2020$NY.GDP.MKTP.CD[1]
  
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 1960 & Year <= 2019) %>%
    mutate(Decade = as.numeric(paste0(substr(Year, 1, 3), '0'))) %>%
    rename(Group = `Disaster Subgroup`) %>%
    rename(Type = `Disaster Type`) %>%
    rename(Affected = `Total Affected`) %>%
    mutate(Damages = `Total Damages, Adjusted ('000 US$)`*1000/GDP_2020 * 100) %>%
    select(Decade, Group, Type, Affected, Damages)
  
  df <- df %>%
    group_by(Decade, Type) %>%
      summarise(Frequency = n(),
                Affected = sum(Affected, na.rm=TRUE),
                Damages = sum(Damages, na.rm=TRUE),
                .groups = 'drop') %>%
    filter(Damages > 0)
  
  # chart
  figure(
    data =  df,
    plot = function(df, style = style_SAR_CCDR()) {
      p <- ggplot(df, aes(x=Decade, y=reorder(Type, desc(Type)), size=Damages, color=Affected, fill=Affected)) +
        geom_point(alpha=0.5, shape=21, color="black") +
        scale_size(range = c(1, 20), name="Damage (%GDP)",
                   breaks = c(1, 4, 8),
                   labels = c("1", "4", "8")) +
        scale_fill_distiller(palette = "Accent", direction=1) +
        scale_x_continuous(limits = c(1960, 2014), breaks = c(1960, 1970, 1980, 1990, 2000, 2010), labels = c("1960-1969", "1970-1979", "1980-1989", "1990-1999", "2000-2009", "2010-2019")) +
        xlab("Year") +
        ylab("Natural Disasters") +
        geom_curve(aes(x = 1990, y = 4.5, xend = 1997, yend = 5),
                               colour = "#555555",
                               size=0.3,
                               curvature = -0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 1990, y = 4.3, label = "including 2005 Kashmir earthquake", size = 2.5, family = style$family) +
        geom_curve(aes(x = 1975, y = 2, xend = 1973, yend = 2.8),
                               colour = "#555555",
                               size=0.3,
                               curvature = 0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 1975, y = 1.8, label = "including 1970 East Pakistan cyclone", size = 2.5, family = style$family) +
        geom_curve(aes(x = 2000, y = 1.8, xend = 2006, yend = 2.6),
                               colour = "#555555",
                               size=0.3,
                               curvature = -0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 2000, y = 1.6, label = "including 2010 floods", size = 2.5, family = style$family) +
        style$theme() +
        theme(
          axis.title.x = element_text(vjust = -5),
          axis.title.y = element_text(angle = 90, vjust = 0, margin = margin(r = 15)),
          axis.text.x = element_text(angle = 0, vjust = 2), 
          legend.title = element_text(),
          legend.box.just = "center",
          legend.position = "right"
        )
    },
    aspect_ratio = 1,
    # title = "Floods and earthquakes are the most damaging natural disasters in Pakistan.",
    subtitle = "Decadal sum: Number of people affected and economic damages (% GDP) from natural disasters",
    note = "Note: Decadal figures are measured as the annual sum over the subsequent ten-year period.",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disasters_var2()

figure_save_draft_png(fig_ch1_natural_disasters_var2(), style_SAR_CCDR, "../png/fig_ch1_natural_disasters_var2.png", height=4.1, width=5.5)

```





&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Number of events and economic damages (% GDP) from natural disasters

Data source: https://public.emdat.be/data

Variables: Frequency and economic damages

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=4.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disasters_var3 <- function() {
  
  # data
  GDP_2020 <- wb_data(
    indicator = c("NY.GDP.MKTP.CD"),
    country = c("PAK"),
    start_date = 2020,
    end_date = 2020
  )
  GDP_2020 <- GDP_2020$NY.GDP.MKTP.CD[1]
  
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 1960 & Year <= 2019) %>%
    mutate(Decade = as.numeric(paste0(substr(Year, 1, 3), '0'))) %>%
    rename(Group = `Disaster Subgroup`) %>%
    rename(Type = `Disaster Type`) %>%
    rename(Affected = `Total Affected`) %>%
    mutate(Damages = `Total Damages, Adjusted ('000 US$)`*1000/GDP_2020 * 100) %>%
    select(Decade, Group, Type, Affected, Damages)
  
  df <- df %>%
    group_by(Decade, Type) %>%
      summarise(Frequency = n(),
                Affected = sum(Affected, na.rm=TRUE),
                Damages = sum(Damages, na.rm=TRUE),
                .groups = 'drop') %>%
    filter(Damages > 0)
  
  # chart
  figure(
    data =  df,
    plot = function(df, style = style_SAR_CCDR()) {
      p <- ggplot(df, aes(x=Decade, y=reorder(Type, desc(Type)), size=Damages, color=Frequency, fill=Frequency)) +
        geom_point(alpha=0.5, shape=21, color="black") +
        scale_size(range = c(1, 20), name="Damage (%GDP)",
                   breaks = c(1, 4, 8),
                   labels = c("1", "4", "8")) +
        scale_fill_distiller(palette = "YlGnBu", direction=1) +
        scale_x_continuous(limits = c(1960, 2014), breaks = c(1960, 1970, 1980, 1990, 2000, 2010), labels = c("1960-1969", "1970-1979", "1980-1989", "1990-1999", "2000-2009", "2010-2019")) +
        xlab("Year") +
        ylab("Natural Disasters") +
        geom_curve(aes(x = 1990, y = 4.5, xend = 1997, yend = 5),
                               colour = "#555555",
                               size=0.3,
                               curvature = -0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 1990, y = 4.3, label = "including 2005 Kashmir earthquake", size = 2.5, family = style$family) +
        geom_curve(aes(x = 1975, y = 2, xend = 1973, yend = 2.8),
                               colour = "#555555",
                               size=0.3,
                               curvature = 0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 1975, y = 1.8, label = "including 1970 East Pakistan cyclone", size = 2.5, family = style$family) +
        geom_curve(aes(x = 2000, y = 1.8, xend = 2006, yend = 2.6),
                               colour = "#555555",
                               size=0.3,
                               curvature = -0.2,
                               arrow = arrow(length = unit(0.03, "npc"))) +
        annotate("text", x = 2000, y = 1.6, label = "including 2010 floods", size = 2.5, family = style$family) +
        style$theme() +
        theme(
          axis.title.x = element_text(vjust = -5),
          axis.title.y = element_text(angle = 90, vjust = 0, margin = margin(r = 15)),
          axis.text.x = element_text(angle = 0, vjust = 2), 
          legend.title = element_text(),
          legend.box.just = "center",
          legend.position = "right"
        )
    },
    aspect_ratio = 1,
    # title = "Floods and earthquakes are the most damaging natural disasters in Pakistan.",
    subtitle = "Decadal sum: Number of events and economic damages (% GDP) from natural disasters",
    note = "Note: Decadal figures are measured as the annual sum over the subsequent ten-year period.",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disasters_var3()

figure_save_draft_png(fig_ch1_natural_disasters_var3(), style_SAR_CCDR, "../png/fig_ch1_natural_disasters_var3.png", height=4.1, width=5.5)

```




&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Natural disasters in recent years

Data source: https://public.emdat.be/data


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disaster_frequency <- function() {
  
  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 2000) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Deaths`, `Total Damages, Adjusted ('000 US$)`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_deaths = sum(`Total Deaths`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_deaths =  100 *category_deaths/sum(category_deaths, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              deaths = sum(`Total Deaths`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  # chart
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.category <- df.category %>%
        arrange(desc(category_frequency))
      df.category$ymax <- cumsum(df.category$category_frequency)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$labelPosition <- c(45.0, 102.5, 123.5, 138.0, 144.55)
      df.category$label <- paste0(df.category$category, "\n(", df.category$category_frequency, ")")
      df.category$label <- c("Hydrological\n(90)", "Meteorological\n(25)", "Geophysical\n(17)", "Biological\n(12)", "" )
      
      df.type <- df.type %>%
        arrange(desc(category_frequency), desc(frequency))
      df.type$ymax <- cumsum(df.type$frequency)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type)
      df.type$label <- c("Flood", "Landslide", "Storm", "Extrm temp", "Earthquake", "Mass movement", "Epidemic", "Insect", "" )
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)
  
      ggplot() +
      geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
      geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
      # geom_text_repel(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=3, box.padding = unit(0, "lines"), 
      #                 show.legend = F, nudge_x = 0) +
      geom_text(data = df.category, x=2.8, aes(y = labelPosition, label = label, family=style$family), size=3) +
      geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2.5, show.legend = F) + 
      coord_polar(theta="y") +
      xlim(c(1, 4.5)) +
      scale_fill_manual(values = c(
      "Hydrological" = "#07A0C3", 
      "Meteorological" = "#4D8B31",   
      "Geophysical" = "#EF476F",   
      "Biological" = "#F0C808",   
      "Climatological" = "#A15E49"))+
      annotate(geom = 'text', x = 1, y = 0, label = "Frequency") +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank())
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years",
    subtitle = "Frequency of natural disasters by type, 2000-2022",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disaster_frequency()

figure_save_draft_png(fig_ch1_natural_disaster_frequency(), style_SAR_CCDR, "../png/fig_ch1_natural_disaster_frequency.png", height=5.1, width=5.5)
```


### Natural disasters in recent years

Data source: https://public.emdat.be/data

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disaster_frequency_var1 <- function() {
  
  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 1990 & Year <= 2021) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Deaths`, `Total Damages, Adjusted ('000 US$)`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_deaths = sum(`Total Deaths`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_deaths =  100 *category_deaths/sum(category_deaths, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              deaths = sum(`Total Deaths`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  # chart
  color_list <- c(
    "Hydrological" = style$colors$blue, 
    "Meteorological" = style$colors$purple,   
    "Geophysical" = style$colors$red,   
    "Biological" = style$colors$orange,   
    "Climatological" = style$colors$navy.light)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.category <- df.category %>%
        arrange(desc(category_frequency))
      df.category$ymax <- cumsum(df.category$category_frequency)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$labelPosition <- c(55.0, 128.5, 159.5, 179.0, 187.0)
      df.category$label <- paste0(df.category$category, "\n(", df.category$category_frequency, ")")
      df.category$label <- c("Hydrological\n(110)", "Meteorological\n(37)", "Geophysical\n(25)", "Biological\n(14)", "")
      df.category$vjust <- c(0.5, 0.5, 0.5, 0.9, 0.0)
      
      df.type <- df.type %>%
        arrange(desc(category_frequency), desc(frequency))
      df.type$ymax <- cumsum(df.type$frequency)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, " (", df.type$frequency, ")")
      df.type$label <- c("Flood (90)", "Landslide (20)", "Storm (22)", "Extreme temperature (15)", "Earthquake (24)", "Mass movement (dry) (1)", "Epidemic (12)", "Insect infestation (2)", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)
  
      ggplot() +
      geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
      geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
      geom_text(data = df.category, x=2.8, aes(y = labelPosition, label = label, vjust=vjust, family=style$family), size=3) +
      geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2, show.legend = F) + 
      coord_polar(theta="y") +
      xlim(c(1, 5.1)) +
      scale_fill_manual(values = color_list)+
      annotate(geom = 'text', x = 1, y = 0, label = "Frequency") +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank(),
            plot.margin = margin(-5,1,-15,1, unit = "mm"))
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years",
    subtitle = "Frequency of natural disasters by type, 1990-2021",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disaster_frequency_var1()

figure_save_draft_png(fig_ch1_natural_disaster_frequency_var1(), style_SAR_CCDR, "../png/fig_ch1_natural_disaster_frequency_var1.png", height=5.1, width=5.5)
```


### Natural disasters in recent years

Data source: https://public.emdat.be/data

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disaster_deaths <- function() {
  
  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 2000) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Deaths`, `Total Damages, Adjusted ('000 US$)`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_deaths = sum(`Total Deaths`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_deaths =  100 *category_deaths/sum(category_deaths, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              deaths = sum(`Total Deaths`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  # chart
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.category <- df.category %>%
        arrange(desc(category_deaths))
      df.category$ymax <- cumsum(df.category$category_deaths)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$labelPosition <- c(37202.5, 76007.0, 85776.0, 85784.5, 85764.5)
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_deaths,big.mark=","), ")")
      df.category$label <- c("Geophysical\n(74,405)", "Hydrological\n(8,304)", "Meteorological\n(2,734)", "", "")
      
      df.type <- df.type %>%
        arrange(desc(category_deaths), desc(deaths))
      df.type$ymax <- cumsum(df.type$deaths)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type)
      df.type$label <- c("Earthquake", "Mass movement (dry)", "Flood", "Landslide", "Extrm temp", "Storm", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)

  
      ggplot() +
      geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
      geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
      # geom_text_repel(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=3, box.padding = unit(0, "lines"), 
      #                 show.legend = F, nudge_x = 0.5, nudge_y = 0.5) +
      geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=3) +
      geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2.5, show.legend = F) + 
      coord_polar(theta="y") +
      xlim(c(1, 4.5)) +
      scale_fill_manual(values = c(
      "Hydrological" = "#07A0C3", 
      "Meteorological" = "#4D8B31",   
      "Geophysical" = "#EF476F",   
      "Biological" = "#F0C808",   
      "Climatological" = "#A15E49"))+
      annotate(geom = 'text', x = 1, y = 0, label = "Deaths") +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank())
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years",
    subtitle = "Total deaths from natural disasters by type, 2000-2022",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disaster_deaths()

figure_save_draft_png(fig_ch1_natural_disaster_deaths(), style_SAR_CCDR, "../png/fig_ch1_natural_disaster_deaths.png", height=5.1, width=5.5)
```


### Natural disasters in recent years

Data source: https://public.emdat.be/data

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disaster_deaths_var1 <- function() {
  
  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 1990 & Year <= 2021) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Deaths`, `Total Damages, Adjusted ('000 US$)`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_deaths = sum(`Total Deaths`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_deaths =  100 *category_deaths/sum(category_deaths, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              deaths = sum(`Total Deaths`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  # chart
  color_list <- c(
    "Hydrological" = style$colors$blue, 
    "Meteorological" = style$colors$purple,   
    "Geophysical" = style$colors$red,   
    "Biological" = style$colors$orange,   
    "Climatological" = style$colors$navy.light)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.category <- df.category %>%
        arrange(desc(category_deaths))
      df.category$ymax <- cumsum(df.category$category_deaths)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      # df.category$labelPosition <- c(37202.5, 76007.0, 85776.0, 85784.5, 85764.5)
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_deaths,big.mark=","), ")")
      df.category$label <- c("Geophysical\n(74,818)", "Hydrological\n(12,679)", "Meteorological\n(4,352)", "", "")
      df.category$vjust <- c(0.5, 0.5, 0.2, 0.5, 0.5)
      
      df.type <- df.type %>%
        arrange(desc(category_deaths), desc(deaths))
      df.type$ymax <- cumsum(df.type$deaths)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, "\n(", prettyNum(df.type$deaths,big.mark=","), ")")
      df.type$label <- c("Earthquake\n(74,805)", "Mass movement (dry)\n(13)", "Flood\n(12,017)", "Landslide\n(662)", "Extreme temperature\n(2,759)", "Storm\n(1,593)", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)

  
      ggplot() +
      geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
      geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
      geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, vjust=vjust, family=style$family), size=3) +
      geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2, show.legend = F) + 
      coord_polar(theta="y") +
      xlim(c(1, 5.2)) +
      scale_fill_manual(values = color_list)+
      annotate(geom = 'text', x = 1, y = 0, label = "Deaths") +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank(),
            plot.margin = margin(-5,1,-15, unit = "mm"))
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years",
    subtitle = "Total deaths from natural disasters by type, 1990-2021",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disaster_deaths_var1()

figure_save_draft_png(fig_ch1_natural_disaster_deaths_var1(), style_SAR_CCDR, "../png/fig_ch1_natural_disaster_deaths_var1.png", height=5.1, width=5.5)
```


### Natural disasters in recent years

Data source: https://public.emdat.be/data

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disaster_damage <- function() {
  
  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 2000) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Deaths`, `Total Damages, Adjusted ('000 US$)`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_deaths = sum(`Total Deaths`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_deaths =  100 *category_deaths/sum(category_deaths, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              deaths = sum(`Total Deaths`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.category <- df.category %>%
        arrange(desc(category_damage))
      df.category$ymax <- cumsum(df.category$category_damage)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_damage,big.mark=","), ")")
      df.category$label <- c("Hydrological\n(24,504,498)", "Geophysical\n(7,362,752)", "Meteorological\n(2,237,146)", "", "")
      
      df.type <- df.type %>%
        arrange(desc(category_damage), desc(damage))
      df.type$ymax <- cumsum(df.type$damage)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180,
                              90 - df.type$labelPosition/max(df.type$ymax)*360,
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type)
      df.type$label <- c("Flood", "", "Earthquake", "Mass movement", "Storm", "", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)

  
      ggplot() +
      geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
      geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
      geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=3, box.padding = unit(0, "lines"), 
                      show.legend = F) +
      geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2.5, show.legend = F) + 
      coord_polar(theta="y") +
      xlim(c(1, 4.5)) +
      scale_fill_manual(values = c(
      "Hydrological" = "#07A0C3", 
      "Meteorological" = "#4D8B31",   
      "Geophysical" = "#EF476F",   
      "Biological" = "#F0C808",   
      "Climatological" = "#A15E49"))+
      annotate(geom = 'text', x = 1, y = 0, label = "Damage") +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank())
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years",
    subtitle = "Total damages from natural disasters by type, Adjusted ('000 US$), 2000-2022",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disaster_damage()

figure_save_draft_png(fig_ch1_natural_disaster_damage(), style_SAR_CCDR, "../png/fig_ch1_natural_disaster_damage.png", height=5.1, width=5.5)
```

### Natural disasters in recent years

Data source: https://public.emdat.be/data

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disaster_damage_var1 <- function() {
  
  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 1990 & Year <= 2021) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Deaths`, `Total Damages, Adjusted ('000 US$)`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_deaths = sum(`Total Deaths`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_deaths =  100 *category_deaths/sum(category_deaths, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              deaths = sum(`Total Deaths`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  # chart
  color_list <- c(
    "Hydrological" = style$colors$blue, 
    "Meteorological" = style$colors$purple,   
    "Geophysical" = style$colors$red,   
    "Biological" = style$colors$orange,   
    "Climatological" = style$colors$navy.light)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.category <- df.category %>%
        arrange(desc(category_damage))
      df.category$ymax <- cumsum(df.category$category_damage)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_damage,big.mark=","), ")")
      df.category$label <- c("Hydrological\n(26,604,257)", "Geophysical\n(7,384,722)", "Meteorological\n(2,254,936)", "", "")
      
      df.type <- df.type %>%
        arrange(desc(category_damage), desc(damage))
      df.type$ymax <- cumsum(df.type$damage)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180,
                              90 - df.type$labelPosition/max(df.type$ymax)*360,
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, "\n(", prettyNum(df.type$damage,big.mark=","), ")")
      df.type$label <- c("Flood\n(26,581,889)", "Landslide\n(22,368)", "Earthquake\n(7,384,722)", "", "Storm\n(2,234,333)", "", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)

  
      ggplot() +
      geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
      geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
      geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=3, box.padding = unit(0, "lines"), 
                      show.legend = F) +
      geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2, show.legend = F) + 
      coord_polar(theta="y") +
      xlim(c(1, 5.1)) +
      scale_fill_manual(values = color_list)+
      annotate(geom = 'text', x = 1, y = 0, label = "Damage") +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank(),
            plot.margin = margin(-5,1,-15, unit = "mm"))
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years",
    subtitle = "Total damages from natural disasters by type, Adjusted ('000 US$), 1990-2021",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disaster_damage_var1()

figure_save_draft_png(fig_ch1_natural_disaster_damage_var1(), style_SAR_CCDR, "../png/fig_ch1_natural_disaster_damage_var1.png", height=5.1, width=5.5)
```


### Natural disasters in recent years

Data source: https://public.emdat.be/data

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_natural_disaster_affected_var1 <- function() {
  
  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 1990 & Year <= 2021) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Affected`, `Total Damages, Adjusted ('000 US$)`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_affected = sum(`Total Affected`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_affected =  100 *category_affected/sum(category_affected, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              affected = sum(`Total Affected`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  # chart
  color_list <- c(
    "Hydrological" = style$colors$blue, 
    "Meteorological" = style$colors$purple,   
    "Geophysical" = style$colors$red,   
    "Biological" = style$colors$orange,   
    "Climatological" = style$colors$navy.light)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.category <- df.category %>%
        arrange(desc(category_affected))
      df.category$ymax <- cumsum(df.category$category_affected)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_affected,big.mark=","), ")")
      df.category$label <- c("Hydrological\n(65,812,788)", "Geophysical\n(7,404,106)", "Climatological\n(6,880,912)", "Meteorological\n(3,274,667)", "")
      df.category$vjust <- c(0.5, 0.5, 0.5, -0.3, 0.5)
      
      df.type <- df.type %>%
        arrange(desc(category_affected), desc(affected))
      df.type$ymax <- cumsum(df.type$affected)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180,
                              90 - df.type$labelPosition/max(df.type$ymax)*360,
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, "\n(", prettyNum(df.type$affected,big.mark=","), ")")
      df.type$label <- c("Flood\n(65,778,734)", "Landslide\n(34,054)", "Earthquake\n(7,404,106)", "", "Drought\n(6,880,912)", "Storm\n(3,194,093)", "Extreme temperature\n(80,574)", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)

  
      ggplot() +
      geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
      geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
      geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, vjust=vjust, family=style$family), size=3, box.padding = unit(0, "lines"), 
                      show.legend = F) +
      geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2, show.legend = F) + 
      coord_polar(theta="y") +
      xlim(c(1, 5.1)) +
      scale_fill_manual(values = color_list)+
      annotate(geom = 'text', x = 1, y = 0, label = "Affected") +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank(),
            plot.margin = margin(-5,1,-15, unit = "mm"))
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years",
    subtitle = "Total affected from natural disasters by type, 1990-2021",
    source = "Source: The international disasters database"
  )
}

fig_ch1_natural_disaster_affected_var1()

figure_save_draft_png(fig_ch1_natural_disaster_affected_var1(), style_SAR_CCDR, "../png/fig_ch1_natural_disaster_affected_var1.png", height=5.1, width=5.5)
```


### Natural disasters in recent years, 2000-2022

Data source: https://public.emdat.be/data

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=13.5, out.width=800, dpi=200}

fig_ch1_recent_natural_disaster <- function() {

  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 2000) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Deaths`, `Total Damages, Adjusted ('000 US$)`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_deaths = sum(`Total Deaths`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_deaths =  100 *category_deaths/sum(category_deaths, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              deaths = sum(`Total Deaths`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  # chart
  
  color_list = c(
    "Hydrological" = "#07A0C3", 
    "Meteorological" = "#4D8B31",   
    "Geophysical" = "#EF476F",   
    "Biological" = "#F0C808",   
    "Climatological" = "#A15E49")
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      # frequency
      df.category <- df.category %>%
        arrange(desc(category_frequency))
      df.category$ymax <- cumsum(df.category$category_frequency)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$labelPosition <- c(45.0, 102.5, 123.5, 138.0, 144.55)
      df.category$label <- paste0(df.category$category, "\n(", df.category$category_frequency, ")")
      df.category$label <- c("Hydrological\n(90)", "Meteorological\n(25)", "Geophysical\n(17)", "Biological\n(12)", "" )
      
      df.type <- df.type %>%
        arrange(desc(category_frequency), desc(frequency))
      df.type$ymax <- cumsum(df.type$frequency)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type)
      df.type$label <- c("Flood", "Landslide", "Storm", "Extrm temp", "Earthquake", "Mass movement", "Epidemic", "Insect", "" )
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)
  
      p.frequency <- ggplot() +
        geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
        geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
        # geom_text_repel(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=3, box.padding = unit(0, "lines"), 
        #                 show.legend = F, nudge_x = 0) +
        geom_text(data = df.category, x=2.8, aes(y = labelPosition, label = label, family=style$family), size=2.7) +
        geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2.5, show.legend = F) + 
        coord_polar(theta="y") +
        xlim(c(1, 4.5)) +
        scale_fill_manual(values = color_list)+
        annotate(geom = 'text', x = 1, y = 0, label = "Frequency") +
        labs(subtitle = "Frequency of natural disasters by type")+
        style$theme() +
        theme(legend.position = "none",
              panel.grid.major.x = element_blank(),
              panel.grid.major.y = element_blank(),
              axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              plot.margin = margin(1,1,0,1, unit = "mm"))
      
      # deaths
      df.category <- df.category %>%
        arrange(desc(category_deaths))
      df.category$ymax <- cumsum(df.category$category_deaths)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$labelPosition <- c(37202.5, 76007.0, 85776.0, 85784.5, 85764.5)
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_deaths,big.mark=","), ")")
      df.category$label <- c("Geophysical\n(74,405)", "Hydrological\n(8,304)", "Meteorological\n(2,734)", "", "")
      
      df.type <- df.type %>%
        arrange(desc(category_deaths), desc(deaths))
      df.type$ymax <- cumsum(df.type$deaths)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type)
      df.type$label <- c("Earthquake", "Mass movement (dry)", "Flood", "Landslide", "Extrm temp", "Storm", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)
  
      p.deaths <- ggplot() +
        geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
        geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
        # geom_text_repel(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=3, box.padding = unit(0, "lines"), 
        #                 show.legend = F, nudge_x = 0.5, nudge_y = 0.5) +
        geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=2.7) +
        geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2.5, show.legend = F) + 
        coord_polar(theta="y") +
        xlim(c(1, 4.5)) +
        scale_fill_manual(values = color_list)+
        annotate(geom = 'text', x = 1, y = 0, label = "Deaths") +
        labs(subtitle = "Total deaths from natural disasters by type")+
        style$theme() +
        theme(legend.position = "none",
              panel.grid.major.x = element_blank(),
              panel.grid.major.y = element_blank(),
              axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              plot.margin = margin(1,1,0,1, unit = "mm"))
      
      # damage
      df.category <- df.category %>%
        arrange(desc(category_damage))
      df.category$ymax <- cumsum(df.category$category_damage)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_damage,big.mark=","), ")")
      df.category$label <- c("Hydrological\n(24,504,498)", "Geophysical\n(7,362,752)", "Meteorological\n(2,237,146)", "", "")
      
      df.type <- df.type %>%
        arrange(desc(category_damage), desc(damage))
      df.type$ymax <- cumsum(df.type$damage)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180,
                              90 - df.type$labelPosition/max(df.type$ymax)*360,
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type)
      df.type$label <- c("Flood", "", "Earthquake", "Mass movement", "Storm", "", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)

      p.damage <- ggplot() +
        geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
        geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
        geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=2.7, box.padding = unit(0, "lines"), 
                        show.legend = F) +
        geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2.5, show.legend = F) + 
        coord_polar(theta="y") +
        xlim(c(1, 4.5)) +
        scale_fill_manual(values = color_list)+
        annotate(geom = 'text', x = 1, y = 0, label = "Damage") +
        labs(subtitle = "Total damages from natural disasters by type, adjusted ('000 US$)")+
        style$theme() +
        theme(legend.position = "none",
              panel.grid.major.x = element_blank(),
              panel.grid.major.y = element_blank(),
              axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              plot.margin = margin(1,1,0,1, unit = "mm"))
      
      pt.frequency <- ggplotGrob(p.frequency)
      pt.deaths <- ggplotGrob(p.deaths)
      pt.damage <- ggplotGrob(p.damage)
  
      chart <- gtable_row(
        "chart", 
        list(pt.frequency, pt.deaths, pt.damage), 
        height = unit(1, "null"), 
        widths = unit.c(unit(1, "null"), unit(1, "null"), unit(1, "null"))
        )
      chart$theme <- style$theme() +
        theme(plot.margin = margin(0,0,0,0, unit = "mm"))
      chart
      
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years, 2000-2022",
    source = "Source: The international disasters database"
  )
}

fig_ch1_recent_natural_disaster()

figure_save_draft_png(fig_ch1_recent_natural_disaster(), style_SAR_CCDR, "../png/fig_ch1_recent_natural_disaster.png", height=5.1, width=13.5)

```



### Natural disasters in recent years, 1990-2021

Data source: https://public.emdat.be/data


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=12.5, out.width=800, dpi=200}

fig_ch1_recent_natural_disaster_var1 <- function() {

  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 1990 & Year <= 2021) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Deaths`, `Total Damages, Adjusted ('000 US$)`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_deaths = sum(`Total Deaths`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_deaths =  100 *category_deaths/sum(category_deaths, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              deaths = sum(`Total Deaths`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  # chart
  color_list <- c(
    "Hydrological" = style$colors$blue, 
    "Meteorological" = style$colors$purple,   
    "Geophysical" = style$colors$red,   
    "Biological" = style$colors$orange,   
    "Climatological" = style$colors$navy.light)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      # frequency
      df.category <- df.category %>%
        arrange(desc(category_frequency))
      df.category$ymax <- cumsum(df.category$category_frequency)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$labelPosition <- c(55.0, 128.5, 159.5, 179.0, 187.0)
      df.category$label <- paste0(df.category$category, "\n(", df.category$category_frequency, ")")
      df.category$label <- c("Hydrological\n(110)", "Meteorological\n(37)", "Geophysical\n(25)", "Biological\n(14)", "")
      df.category$vjust <- c(0.5, 0.5, 0.5, 0.9, 0.0)
      
      df.type <- df.type %>%
        arrange(desc(category_frequency), desc(frequency))
      df.type$ymax <- cumsum(df.type$frequency)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, " (", df.type$frequency, ")")
      df.type$label <- c("Flood (90)", "Landslide (20)", "Storm (22)", "Extreme temperature (15)", "Earthquake (24)", "Mass movement (dry) (1)", "Epidemic (12)", "Insect infestation (2)", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)
  
      p.frequency <- ggplot() +
        geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
        geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
        geom_text(data = df.category, x=2.8, aes(y = labelPosition, label = label, vjust=vjust, family=style$family), size=3) +
        geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2, show.legend = F) + 
        coord_polar(theta="y") +
        xlim(c(1, 5.1)) +
        scale_fill_manual(values = color_list)+
        annotate(geom = 'text', x = 1, y = 0, label = "Frequency") +
        labs(subtitle = "Frequency of natural disasters by type")+
        style$theme() +
        theme(legend.position = "none",
              panel.grid.major.x = element_blank(),
              panel.grid.major.y = element_blank(),
              axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              plot.margin = margin(-2,-5,-15,-5, unit = "mm"))
      
      # deaths
      df.category <- df.category %>%
        arrange(desc(category_deaths))
      df.category$ymax <- cumsum(df.category$category_deaths)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      # df.category$labelPosition <- c(37202.5, 76007.0, 85776.0, 85784.5, 85764.5)
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_deaths,big.mark=","), ")")
      df.category$label <- c("Geophysical\n(74,818)", "Hydrological\n(12,679)", "Meteorological\n(4,352)", "", "")
      df.category$vjust <- c(0.5, 0.5, 0.2, 0.5, 0.5)
      
      df.type <- df.type %>%
        arrange(desc(category_deaths), desc(deaths))
      df.type$ymax <- cumsum(df.type$deaths)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, "\n(", prettyNum(df.type$deaths,big.mark=","), ")")
      df.type$label <- c("Earthquake\n(74,805)", "Mass movement (dry)\n(13)", "Flood\n(12,017)", "Landslide\n(662)", "Extreme temperature\n(2,759)", "Storm\n(1,593)", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)
  
      p.deaths <- ggplot() +
        geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
        geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
        geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, vjust=vjust, family=style$family), size=3) +
        geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2, show.legend = F) + 
        coord_polar(theta="y") +
        xlim(c(1, 5.2)) +
        scale_fill_manual(values = color_list)+
        annotate(geom = 'text', x = 1, y = 0, label = "Deaths") +
        labs(subtitle = "Total deaths from natural disasters by type")+
        style$theme() +
        theme(legend.position = "none",
              panel.grid.major.x = element_blank(),
              panel.grid.major.y = element_blank(),
              axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              plot.margin = margin(-5,-5,-15,-5, unit = "mm"))
      
      # damage
      df.category <- df.category %>%
        arrange(desc(category_damage))
      df.category$ymax <- cumsum(df.category$category_damage)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_damage,big.mark=","), ")")
      df.category$label <- c("Hydrological\n(26,604,257)", "Geophysical\n(7,384,722)", "Meteorological\n(2,254,936)", "", "")
      
      df.type <- df.type %>%
        arrange(desc(category_damage), desc(damage))
      df.type$ymax <- cumsum(df.type$damage)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180,
                              90 - df.type$labelPosition/max(df.type$ymax)*360,
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, "\n(", prettyNum(df.type$damage,big.mark=","), ")")
      df.type$label <- c("Flood\n(26,581,889)", "Landslide\n(22,368)", "Earthquake\n(7,384,722)", "", "Storm\n(2,234,333)", "", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)

      p.damage <- ggplot() +
        geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
        geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
        geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=3, box.padding = unit(0, "lines"), 
                  show.legend = F) +
        geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2, show.legend = F) + 
        coord_polar(theta="y") +
        xlim(c(1, 5.1)) +
        scale_fill_manual(values = color_list)+
        annotate(geom = 'text', x = 1, y = 0, label = "Damage") +
        labs(subtitle = "Total damages from natural disasters by type, adjusted ('000 US$)")+
        style$theme() +
        theme(legend.position = "none",
              panel.grid.major.x = element_blank(),
              panel.grid.major.y = element_blank(),
              axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              plot.margin = margin(-2,-5,-15,-5, unit = "mm"))
      
      pt.frequency <- ggplotGrob(p.frequency)
      pt.deaths <- ggplotGrob(p.deaths)
      pt.damage <- ggplotGrob(p.damage)
  
      chart <- gtable_row(
        "chart", 
        list(pt.frequency, pt.deaths, pt.damage), 
        height = unit(1, "null"), 
        widths = unit.c(unit(1, "null"), unit(1, "null"), unit(1, "null"))
        )
      chart$theme <- style$theme() +
        theme(plot.margin = margin(0,0,0,0, unit = "mm"))
      chart
      
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years, 1990-2021",
    source = "Source: The international disasters database"
  )
}

fig_ch1_recent_natural_disaster_var1()

figure_save_draft_png(fig_ch1_recent_natural_disaster_var1(), style_SAR_CCDR, "../png/fig_ch1_recent_natural_disaster_var1.png", height=5.1, width=12.5)

```


### Natural disasters in recent years, 1990-2021

Data source: https://public.emdat.be/data


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=6.8, fig.width=6.5, out.width=800, dpi=200}

fig_ch1_recent_natural_disaster_var2 <- function() {

  # data
  df <- read_excel("../data/emdat_public_2022_03_14_Pakistan.xlsx", skip=6) %>%
    filter(Year >= 1990 & Year <= 2021) %>%
    select(`Disaster Subgroup`, `Disaster Type`, `Total Deaths`, `Total Damages, Adjusted ('000 US$)`, `Total Affected`) %>% 
    rename(category = `Disaster Subgroup`) %>%
    rename(type = `Disaster Type`)
  
  df.category <- df %>%
    group_by(category) %>%
    summarise(category_frequency = n(),
              category_deaths = sum(`Total Deaths`, na.rm=TRUE),
              category_damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              category_affected = sum(`Total Affected`, na.rm=TRUE)) %>%
    mutate(percentage_frequency =  100 *category_frequency/sum(category_frequency, na.rm=TRUE)) %>%
    mutate(percentage_deaths =  100 *category_deaths/sum(category_deaths, na.rm=TRUE)) %>%
    mutate(percentage_damage =  100 *category_damage/sum(category_damage, na.rm=TRUE)) %>%
    mutate(percentage_affected =  100 *category_affected/sum(category_affected, na.rm=TRUE)) 

  df.type <- df %>%
    group_by(category, type) %>%
    summarise(frequency = n(),
              deaths = sum(`Total Deaths`, na.rm=TRUE),
              damage = sum(`Total Damages, Adjusted ('000 US$)`, na.rm=TRUE),
              affected = sum(`Total Affected`, na.rm=TRUE),
              .groups = 'drop') %>%
    inner_join(df.category, by="category") 
  
  # chart
  color_list <- c(
    "Hydrological" = style$colors$blue, 
    "Meteorological" = style$colors$purple,   
    "Geophysical" = style$colors$red,   
    "Biological" = style$colors$orange,   
    "Climatological" = style$colors$navy.light)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      # frequency
      df.category <- df.category %>%
        arrange(desc(category_frequency))
      df.category$ymax <- cumsum(df.category$category_frequency)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$labelPosition <- c(55.0, 128.5, 159.5, 179.0, 187.0)
      df.category$label <- paste0(df.category$category, "\n(", df.category$category_frequency, ")")
      df.category$label <- c("Hydrological\n(110)", "Meteorological\n(37)", "Geophysical\n(25)", "Biological\n(14)", "")
      df.category$vjust <- c(0.5, 0.5, 0.5, 0.2, 0.0)
      
      df.type <- df.type %>%
        arrange(desc(category_frequency), desc(frequency))
      df.type$ymax <- cumsum(df.type$frequency)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, " (", df.type$frequency, ")")
      df.type$label <- c("Flood (90)", "Landslide (20)", "Storm (22)", "Extreme temperature (15)", "Earthquake (24)", "Mass movement (dry) (1)", "Epidemic (12)", "Insect infestation (2)", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)
  
      p.frequency <- ggplot() +
        geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
        geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
        geom_text(data = df.category, x=2.8, aes(y = labelPosition, label = label, vjust=vjust, family=style$family), size=2, lineheight = .9) +
        geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=1.7, lineheight = .9, show.legend = F) + 
        coord_polar(theta="y") +
        xlim(c(1, 5.1)) +
        scale_fill_manual(values = color_list)+
        annotate(geom = 'text', x = 1, y = 0, label = "Frequency", size=3) +
        labs(subtitle = "Frequency of natural disasters by type")+
        style$theme() +
        theme(legend.position = "none",
              plot.subtitle=element_text(hjust=0.5),
              panel.grid.major.x = element_blank(),
              panel.grid.major.y = element_blank(),
              axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              plot.margin = margin(0,-5,0,-5, unit = "mm"))
      
      # deaths
      df.category <- df.category %>%
        arrange(desc(category_deaths))
      df.category$ymax <- cumsum(df.category$category_deaths)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      # df.category$labelPosition <- c(37202.5, 76007.0, 85776.0, 85784.5, 85764.5)
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_deaths,big.mark=","), ")")
      df.category$label <- c("Geophysical\n(74,818)", "Hydrological\n(12,679)", "Meteorological\n(4,352)", "", "")
      df.category$vjust <- c(0.5, 0.5, 0.1, 0.5, 0.5)
      
      df.type <- df.type %>%
        arrange(desc(category_deaths), desc(deaths))
      df.type$ymax <- cumsum(df.type$deaths)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180, 
                              90 - df.type$labelPosition/max(df.type$ymax)*360, 
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, "\n(", prettyNum(df.type$deaths,big.mark=","), ")")
      df.type$label <- c("Earthquake\n(74,805)", "Mass movement (dry)\n(13)", "Flood\n(12,017)", "Landslide\n(662)", "Extreme temperature\n(2,759)", "Storm\n(1,593)", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)
  
      p.deaths <- ggplot() +
        geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
        geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
        geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, vjust=vjust, family=style$family), size=2, lineheight = .9) +
        geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=1.7, lineheight = .9, show.legend = F) + 
        coord_polar(theta="y") +
        xlim(c(1, 5.1)) +
        scale_fill_manual(values = color_list)+
        annotate(geom = 'text', x = 1, y = 0, label = "Deaths", size=3) +
        labs(subtitle = "Total deaths from natural disasters by type")+
        style$theme() +
        theme(legend.position = "none",
              plot.subtitle=element_text(hjust=0.5),
              panel.grid.major.x = element_blank(),
              panel.grid.major.y = element_blank(),
              axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              plot.margin = margin(5,-5,-10,-5, unit = "mm"))
      
      # damage
      df.category <- df.category %>%
        arrange(desc(category_damage))
      df.category$ymax <- cumsum(df.category$category_damage)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_damage,big.mark=","), ")")
      df.category$label <- c("Hydrological\n(26,604,257)", "Geophysical\n(7,384,722)", "Meteorological\n(2,254,936)", "", "")
      
      df.type <- df.type %>%
        arrange(desc(category_damage), desc(damage))
      df.type$ymax <- cumsum(df.type$damage)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180,
                              90 - df.type$labelPosition/max(df.type$ymax)*360,
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, "\n(", prettyNum(df.type$damage,big.mark=","), ")")
      df.type$label <- c("Flood\n(26,581,889)", "Landslide\n(22,368)", "Earthquake\n(7,384,722)", "", "Storm\n(2,234,333)", "", "", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)

      p.damage <- ggplot() +
        geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
        geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
        geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, family=style$family), size=2, lineheight = .9, box.padding = unit(0, "lines"), 
                  show.legend = F) +
        geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=1.7, lineheight = .9, show.legend = F) + 
        coord_polar(theta="y") +
        xlim(c(1, 5.1)) +
        scale_fill_manual(values = color_list)+
        annotate(geom = 'text', x = 1, y = 0, label = "Damage", size=3) +
        labs(subtitle = "Total damages from natural disasters by type, adjusted ('000 US$)")+
        style$theme() +
        theme(legend.position = "none",
              plot.subtitle=element_text(hjust=0.5),
              panel.grid.major.x = element_blank(),
              panel.grid.major.y = element_blank(),
              axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              plot.margin = margin(0,-5,0,-5, unit = "mm"))
      
      # affected
      df.category <- df.category %>%
        arrange(desc(category_affected))
      df.category$ymax <- cumsum(df.category$category_affected)
      df.category$ymin <- c(0, head(df.category$ymax, n=-1))
      df.category$labelPosition <- (df.category$ymax + df.category$ymin) / 2
      df.category$label <- paste0(df.category$category, "\n(", prettyNum(df.category$category_affected,big.mark=","), ")")
      df.category$label <- c("Hydrological\n(65,812,788)", "Geophysical\n(7,404,106)", "Climatological\n(6,880,912)", "Meteorological\n(3,274,667)", "")
      df.category$vjust <- c(0.5, 0.5, 0.5, -0.3, 0.5)
      
      df.type <- df.type %>%
        arrange(desc(category_affected), desc(affected))
      df.type$ymax <- cumsum(df.type$affected)
      df.type$ymin <- c(0, head(df.type$ymax, n=-1))
      df.type$labelPosition <- (df.type$ymax + df.type$ymin) / 2
      df.type$angle <- ifelse(df.type$labelPosition/max(df.type$ymax)*360 < 180,
                              90 - df.type$labelPosition/max(df.type$ymax)*360,
                              df.type$labelPosition/max(df.type$ymax)*360*-1 + 270)
      df.type$label <- paste0(df.type$type, "\n(", prettyNum(df.type$affected,big.mark=","), ")")
      df.type$label <- c("Flood\n(65,778,734)", "Landslide\n(34,054)", "Earthquake\n(7,404,106)", "", "Drought\n(6,880,912)", "Storm\n(3,194,093)", "Extreme temperature\n(80,574)", "", "")
      df.type$hjust <- c(0, 1, 1, 1, 1, 1, 1, 1, 1)
  
      p.affected <- ggplot() +
      geom_rect(data=df.category, aes(ymax=ymax, ymin=ymin, xmax=3.5, xmin=2, fill=category), color = "white", size=1) +
      geom_rect(data=df.type, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3.5, fill=category), color = "white", size=1, alpha = 0.4) +
      geom_text(data = df.category, x=2.6, aes(y = labelPosition, label = label, vjust=vjust, family=style$family), size=2, lineheight = .9, box.padding = unit(0, "lines"), 
                      show.legend = F) +
      geom_text(data = df.type, x=4.1, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=1.7, lineheight = .9, show.legend = F) + 
      coord_polar(theta="y") +
      xlim(c(1, 5.1)) +
      scale_fill_manual(values = color_list)+
      annotate(geom = 'text', x = 1, y = 0, label = "Affected", size=3) +
      labs(subtitle = "Total affected from natural disasters by type") +
      style$theme() +
      theme(legend.position = "none",
            plot.subtitle=element_text(hjust=0.5),
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank(),
            plot.margin = margin(5,-5,-10,-5, unit = "mm"))
      
      # merge charts
      pt.frequency <- ggplotGrob(p.frequency)
      pt.deaths <- ggplotGrob(p.deaths)
      pt.damage <- ggplotGrob(p.damage)
      pt.affected <- ggplotGrob(p.affected)
      
      mat <- matrix(list(pt.frequency, pt.deaths, pt.damage, pt.affected), nrow = 2)
  
      chart <- gtable_matrix(
        "chart", 
        mat, 
        unit(c(1, 1), "null"), 
        unit(c(1, 1), "null"))
      
      chart$theme <- style$theme() +
        theme(plot.margin = margin(0,0,0,0, unit = "mm"))
      
      chart
      
    },
    aspect_ratio = 1,
    # title = "Natural disasters in recent years, 1990-2021",
    source = "Source: The international disasters database"
  )
}

fig_ch1_recent_natural_disaster_var2()

figure_save_draft_png(fig_ch1_recent_natural_disaster_var2(), style_SAR_CCDR, "../png/fig_ch1_recent_natural_disaster_var2.png", height=6.8, width=6.5)

```







&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Total CO2 emissions

Data source: WDI

Indicators: EN.ATM.CO2E.KT

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=4.1, fig.width=6.5, out.width=800, dpi=200}
fig_ch1_total_CO2_emissions <- function() {
  
  # data
  df <- wb_data(
    indicator = c("EN.ATM.CO2E.KT"),
    country = c("HIC", "UMC", "LMC", "LIC", "SAS", "PAK", "CHN", "IND", "USA", "CAN", "AUS", "EUU"),
    start_date = 1990,
    end_date = 2018
  )

  df <- df %>% 
    mutate(num_def = EN.ATM.CO2E.KT) %>% 
    select(iso3c, country, date, num_def)

  # chart
  color_list = c(
    "XD" = style$colors$neutral.dark, 
    "XT" = style$colors$neutral.dark, 
    "XN" = style$colors$neutral.dark, 
    "XM" = style$colors$neutral.dark, 
    "SAS" = style$colors$orange, 
    "PAK" = style$colors$blue, 
    "CHN" = style$colors$neutral.light,
    "IND" = style$colors$neutral.light, 
    "USA" = style$colors$neutral.light, 
    "CAN" = style$colors$neutral.light, 
    "AUS" = style$colors$neutral.light, 
    "EUU" = style$colors$neutral.light)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = date, y = num_def, color = iso3c)) +
      geom_line(size = style$linesize) +
      geom_line(data = df %>% filter(iso3c == "PAK"), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,0)) +
        scale_y_continuous(
          labels = millions(),
          position="left",
          sec.axis = dup_axis(
            breaks = df %>% filter(date == max(date)) %>% pull(num_def) %>% repel(gap=500000, force = TRUE),
            labels = df %>% filter(date == max(date)) %>% pull(country)
          )) +
        scale_color_manual(values = color_list) +
        style$theme()
    },
    aspect_ratio = 1.5,
    # title = paste0("Carbon dioxide (CO2) emissions"),
    subtitle = "Annual CO2 emissions (Gt)",
    source = "Source: Carbon Dioxide Information Analysis Center. World Development Indicators (EN.ATM.CO2E.KT)."
  )
}

fig_ch1_total_CO2_emissions()

figure_save_draft_png(fig_ch1_total_CO2_emissions(), style_SAR_CCDR, "../png/fig_ch1_total_CO2_emissions.png", height=4.1, width=6.5)
```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Per capita CO2 emissions

Data source: WDI

Indicators: EN.ATM.CO2E.PC

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=4.1, fig.width=6.5, out.width=800, dpi=200}
fig_ch1_per_capita_CO2_emissions <- function() {
  
  # data
  df <- wb_data(
    indicator = c("EN.ATM.CO2E.PC"),
    country = c("HIC", "UMC", "LMC", "LIC", "SAS", "PAK", "CHN", "IND", "USA", "CAN", "AUS", "EUU"),
    start_date = 1990,
    end_date = 2018
  )
  
  df <- df %>% 
    mutate(num_def = EN.ATM.CO2E.PC) %>% 
    select(iso3c, country, date, num_def)

  # chart
  color_list = c(
    "XD" = style$colors$neutral.dark, 
    "XT" = style$colors$neutral.dark, 
    "XN" = style$colors$neutral.dark, 
    "XM" = style$colors$neutral.dark, 
    "SAS" = style$colors$orange, 
    "PAK" = style$colors$blue, 
    "CHN" = style$colors$neutral.light,
    "IND" = style$colors$neutral.light, 
    "USA" = style$colors$neutral.light, 
    "CAN" = style$colors$neutral.light, 
    "AUS" = style$colors$neutral.light, 
    "EUU" = style$colors$neutral.light)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = date, y = num_def, color = iso3c)) +
      geom_line(size = style$linesize) +
      geom_line(data = df %>% filter(iso3c == "PAK"), size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$date), expand=c(0,0)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = df %>% filter(date == max(date)) %>% pull(num_def) %>% repel(gap=0.7, force = TRUE),
            labels = df %>% filter(date == max(date)) %>% pull(country)
          )) +
        scale_color_manual(values = color_list) +
        style$theme()
    },
    aspect_ratio = 1.5,
    # title = paste0("Carbon dioxide (CO2) emissions are growing exponentially in the South Asia region."),
    subtitle = "Annual CO2 emissions (metric tons per capita)",
    source = "Source: Carbon Dioxide Information Analysis Center. World Development Indicators (EN.ATM.CO2E.PC)."
  )
}

fig_ch1_per_capita_CO2_emissions()

figure_save_draft_png(fig_ch1_per_capita_CO2_emissions(), style_SAR_CCDR, "../png/fig_ch1_per_capita_CO2_emissions.png", height=4.1, width=6.5)
```




&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Projected Mean-Temperature

Data source: https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=4.5, out.width=800, dpi=200}
fig_ch1_projected_annual_mean_temperature_var1 <- function() {
  
  # data
  df <- read_csv("../data/projected-mean-temperature_edited.csv")
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$blue.light, 
    style$colors$orange,  
    style$colors$red.light, 
    style$colors$red)

  # chart
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean, color=Projection)) +
      geom_line(aes(x=Year, y=Mean, color=Projection), size=2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`, ymax=`10-90th Percentile Range (high)`, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,0)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2005, y = 22.3, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan faces rates of warming considerably above the global average.",
    subtitle = "Projected Mean-Temperature (°C, Baseline: 1995-2014, Multi-Model Ensemble)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections."
  )
}

fig_ch1_projected_annual_mean_temperature_var1()

figure_save_draft_png(fig_ch1_projected_annual_mean_temperature_var1(), style_SAR_CCDR, "../png/fig_ch1_projected_annual_mean_temperature_var1.png", height=4.1, width=6.5)
```


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=4.5, out.width=800, dpi=200}
fig_ch1_projected_annual_mean_temperature_var2 <- function() {
  
  # data
  # data
  df <- read_csv("../data/projected-mean-temperature.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean, color=Projection)) +
      geom_line(aes(x=Year, y=Mean, color=Projection), size=2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`, ymax=`10-90th Percentile Range (high)`, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,0)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2005, y = 22.3, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan faces rates of warming considerably above the global average.",
    subtitle = "Projected Mean-Temperature (°C)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections."
  )
}

fig_ch1_projected_annual_mean_temperature_var2()

figure_save_draft_png(fig_ch1_projected_annual_mean_temperature_var2(), style_SAR_CCDR, "../png/fig_ch1_projected_annual_mean_temperature_var2.png", height=4.1, width=6.5)
```



```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=4.5, out.width=800, dpi=200}
fig_ch1_projected_annual_mean_temperature_var3 <- function() {
  
  # data
  # data
  df <- read_csv("../data/projected-mean-temperature.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean, color=Projection)) +
      geom_line(aes(x=Year, y=Mean, color=Projection), size=1.5) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`, ymax=`10-90th Percentile Range (high)`, 
                      fill=Projection, color=Projection),alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,0)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2005, y = 22.3, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan faces rates of warming considerably above the global average.",
    subtitle = "Projected Mean-Temperature (°C)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections."
  )
}

fig_ch1_projected_annual_mean_temperature_var3()

figure_save_draft_png(fig_ch1_projected_annual_mean_temperature_var3(), style_SAR_CCDR, "../png/fig_ch1_projected_annual_mean_temperature_var3.png", height=4.1, width=6.5)
```



```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=4.5, out.width=800, dpi=200}
fig_ch1_projected_annual_mean_temperature_var4 <- function() {
  
  # data
  # data
  df <- read_csv("../data/projected-mean-temperature.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean, color=Projection)) +
      geom_line(aes(x=Year, y=Mean, color=Projection), size=1.5) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`, ymax=`10-90th Percentile Range (high)`, 
                      fill=Projection, color=Projection),alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,0)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2005, y = 22.3, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Pakistan faces rates of warming considerably above the global average.",
    subtitle = "Projected Mean-Temperature (°C)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections."
  )
}

fig_ch1_projected_annual_mean_temperature_var4()

figure_save_draft_png(fig_ch1_projected_annual_mean_temperature_var4(), style_SAR_CCDR, "../png/fig_ch1_projected_annual_mean_temperature_var4.png", height=4.1, width=6.5)
```




```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=4.5, out.width=800, dpi=200}
fig_ch1_projected_annual_mean_temperature_var5 <- function() {
  
  # data
  # data
  df <- read_csv("../data/projected-mean-temperature.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean, color=Projection)) +
      geom_line(aes(x=Year, y=Mean, color=Projection), size=1.5) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`, ymax=`10-90th Percentile Range (high)`, 
                      fill=Projection, color=Projection),alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,0)) +
      scale_y_continuous(
        position="left"
      ) +
      # annotate("text", x = 2005, y = 22.3, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme() + 
      style$theme_legend("right")
    },
    aspect_ratio = 1,
    # title = "Pakistan faces rates of warming considerably above the global average.",
    subtitle = "Projected Mean-Temperature (°C)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections."
  )
}

fig_ch1_projected_annual_mean_temperature_var5()

figure_save_draft_png(fig_ch1_projected_annual_mean_temperature_var5(), style_SAR_CCDR, "../png/fig_ch1_projected_annual_mean_temperature_var5.png", height=4.1, width=6.5)
```







&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Projected Changes in Mean-Temperature

Data source: https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}
fig_ch1_projected_temperature_changes <- function() {
  
  # data
  df <- read_csv("../data/projected-mean-temperature.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp126, df.spp245, df.spp370, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$blue.light, 
    style$colors$orange,  
    style$colors$red.light, 
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 1.5, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Mean-Temperature",
    subtitle = "Projected changes in mean-temperature (°C)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_temperature_changes()

figure_save_draft_png(fig_ch1_projected_temperature_changes(), style_SAR_CCDR, "../png/fig_ch1_projected_temperature_changes.png", height=3.1, width=3.2)
```


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}
fig_ch1_projected_temperature_changes_var2 <- function() {
  
  # data
  df <- read_csv("../data/projected-mean-temperature.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 1.5, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Mean-Temperature",
    subtitle = "Projected changes in mean-temperature (°C)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_temperature_changes_var2()

figure_save_draft_png(fig_ch1_projected_temperature_changes_var2(), style_SAR_CCDR, "../png/fig_ch1_projected_temperature_changes_var2.png", height=3.1, width=3.2)
```



```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}
fig_ch1_projected_temperature_changes_var3 <- function() {
  
  # data
  df <- read_csv("../data/projected-mean-temperature.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection),alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 1.5, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Mean-Temperature",
    subtitle = "Projected changes in mean-temperature (°C)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_temperature_changes_var3()

figure_save_draft_png(fig_ch1_projected_temperature_changes_var3(), style_SAR_CCDR, "../png/fig_ch1_projected_temperature_changes_var3.png", height=3.1, width=3.2)
```




```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}
fig_ch1_projected_temperature_changes_var4 <- function() {
  
  # data
  df <- read_csv("../data/projected-mean-temperature.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection),alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 1.5, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Mean-Temperature",
    subtitle = "Projected changes in mean-temperature (°C)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_temperature_changes_var4()

figure_save_draft_png(fig_ch1_projected_temperature_changes_var4(), style_SAR_CCDR, "../png/fig_ch1_projected_temperature_changes_var4.png", height=3.1, width=3.2)
```





```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}
fig_ch1_projected_temperature_changes_var5 <- function() {
  
  # data
  df <- read_csv("../data/projected-mean-temperature.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection),alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left"
      ) +
      # annotate("text", x = 2004, y = 1.5, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme() +
      style$theme_legend("right")
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Mean-Temperature",
    subtitle = "Projected changes in mean-temperature (°C)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_temperature_changes_var5()

figure_save_draft_png(fig_ch1_projected_temperature_changes_var5(), style_SAR_CCDR, "../png/fig_ch1_projected_temperature_changes_var5.png", height=3.1, width=3.2)
```






&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Projected Changes in Precipitation

Data source: https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_precipitation_changes <- function() {
  
  # data
  df <- read_csv("../data/projected-precipitation.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp126, df.spp245, df.spp370, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$blue.light, 
    style$colors$orange,  
    style$colors$red.light, 
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          # breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          breaks = c(15, -10, 40, 65, 90),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 50, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Precipitation",
    subtitle = "Projected changes in precipitation (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_precipitation_changes()

figure_save_draft_png(fig_ch1_projected_precipitation_changes(), style_SAR_CCDR, "../png/fig_ch1_projected_precipitation_changes.png", height=3.1, width=3.2)
```



```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_precipitation_changes_var2 <- function() {
  
  # data
  df <- read_csv("../data/projected-precipitation.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 50, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Precipitation",
    subtitle = "Projected changes in precipitation (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_precipitation_changes_var2()

figure_save_draft_png(fig_ch1_projected_precipitation_changes_var2(), style_SAR_CCDR, "../png/fig_ch1_projected_precipitation_changes_var2.png", height=3.1, width=3.2)
```


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_precipitation_changes_var3 <- function() {
  
  # data
  df <- read_csv("../data/projected-precipitation.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection), alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 50, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Precipitation",
    subtitle = "Projected changes in precipitation (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_precipitation_changes_var3()

figure_save_draft_png(fig_ch1_projected_precipitation_changes_var3(), style_SAR_CCDR, "../png/fig_ch1_projected_precipitation_changes_var3.png", height=3.1, width=3.2)
```


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_precipitation_changes_var4 <- function() {
  
  # data
  df <- read_csv("../data/projected-precipitation.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection), alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 50, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Precipitation",
    subtitle = "Projected changes in precipitation (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_precipitation_changes_var4()

figure_save_draft_png(fig_ch1_projected_precipitation_changes_var4(), style_SAR_CCDR, "../png/fig_ch1_projected_precipitation_changes_var4.png", height=3.1, width=3.2)
```




```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_precipitation_changes_var5 <- function() {
  
  # data
  df <- read_csv("../data/projected-precipitation.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection), alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left"
      ) +
      # annotate("text", x = 2004, y = 50, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme() +
      style$theme_legend("right")
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Precipitation",
    subtitle = "Projected changes in precipitation (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_precipitation_changes_var5()

figure_save_draft_png(fig_ch1_projected_precipitation_changes_var5(), style_SAR_CCDR, "../png/fig_ch1_projected_precipitation_changes_var5.png", height=3.1, width=3.2)
```





&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Projected Changes in Heat Index > 35 

Data source: https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_heat_index_changes <- function() {
  
  # data
  df <- read_csv("../data/projected-days-with-heat-index.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp126, df.spp245, df.spp370, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$blue.light, 
    style$colors$orange,  
    style$colors$red.light, 
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          # breaks = c(15, -10, 40, 65, 90),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 25, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Days with Heat Index > 35°C",
    subtitle = "Projected changes in days with heat index > 35°C",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_heat_index_changes()

figure_save_draft_png(fig_ch1_projected_heat_index_changes(), style_SAR_CCDR, "../png/fig_ch1_projected_heat_index_changes.png", height=3.1, width=3.2)
```


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_heat_index_changes_var2 <- function() {
  
  # data
  df <- read_csv("../data/projected-days-with-heat-index.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          # breaks = c(15, -10, 40, 65, 90),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 25, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Days with Heat Index > 35°C",
    subtitle = "Projected changes in days with heat index > 35°C",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_heat_index_changes_var2()

figure_save_draft_png(fig_ch1_projected_heat_index_changes_var2(), style_SAR_CCDR, "../png/fig_ch1_projected_heat_index_changes_var2.png", height=3.1, width=3.2)
```



```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_heat_index_changes_var3 <- function() {
  
  # data
  df <- read_csv("../data/projected-days-with-heat-index.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection), alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          # breaks = c(15, -10, 40, 65, 90),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 25, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Days with Heat Index > 35°C",
    subtitle = "Projected changes in days with heat index > 35°C",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_heat_index_changes_var3()

figure_save_draft_png(fig_ch1_projected_heat_index_changes_var3(), style_SAR_CCDR, "../png/fig_ch1_projected_heat_index_changes_var3.png", height=3.1, width=3.2)
```


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_heat_index_changes_var4 <- function() {
  
  # data
  df <- read_csv("../data/projected-days-with-heat-index.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection), alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          # breaks = c(15, -10, 40, 65, 90),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 25, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Days with Heat Index > 35°C",
    subtitle = "Projected changes in days with heat index > 35°C",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_heat_index_changes_var4()

figure_save_draft_png(fig_ch1_projected_heat_index_changes_var4(), style_SAR_CCDR, "../png/fig_ch1_projected_heat_index_changes_var4.png", height=3.1, width=3.2)
```



```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_heat_index_changes_var5 <- function() {
  
  # data
  df <- read_csv("../data/projected-days-with-heat-index.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   

  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection), alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left"
      ) +
      # annotate("text", x = 2004, y = 25, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme() +
      style$theme_legend("right")
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Days with Heat Index > 35°C",
    subtitle = "Projected changes in days with heat index > 35°C",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_heat_index_changes_var5()

figure_save_draft_png(fig_ch1_projected_heat_index_changes_var5(), style_SAR_CCDR, "../png/fig_ch1_projected_heat_index_changes_var5.png", height=3.1, width=3.2)
```





&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

### Projected Changes in Average largest 5-day cumulative rainfall 

Data source: https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_cumulative_rainfall_changes <- function() {
  
  # data
  df <- read_csv("../data/projected-average-largest-5-day-cumulative-rainfall.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp126, df.spp245, df.spp370, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$blue.light, 
    style$colors$orange,  
    style$colors$red.light, 
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          # breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          breaks = c(0,  6, 18, 12, 24),
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 15, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Average Largest 5-day Cumulative Rainfall",
    subtitle = "Projected changes in average largest 5-day cumulative rainfall (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_cumulative_rainfall_changes()

figure_save_draft_png(fig_ch1_projected_cumulative_rainfall_changes(), style_SAR_CCDR, "../png/fig_ch1_projected_cumulative_rainfall_changes.png", height=3.1, width=3.2)
```



```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_cumulative_rainfall_changes_var2 <- function() {
  
  # data
  df <- read_csv("../data/projected-average-largest-5-day-cumulative-rainfall.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection),color="grey70",alpha=0.2) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 15, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Average Largest 5-day Cumulative Rainfall",
    subtitle = "Projected changes in average largest 5-day cumulative rainfall (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_cumulative_rainfall_changes_var2()

figure_save_draft_png(fig_ch1_projected_cumulative_rainfall_changes_var2(), style_SAR_CCDR, "../png/fig_ch1_projected_cumulative_rainfall_changes_var2.png", height=3.1, width=3.2)
```



```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_cumulative_rainfall_changes_var3 <- function() {
  
  # data
  df <- read_csv("../data/projected-average-largest-5-day-cumulative-rainfall.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp126 <- df %>%
    select(Year, 8:10) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-2.6`) %>%
    rename_with(~ gsub('SSP1-2.6 ', '', .x)) %>%
    mutate(Projection = "SSP1-2.6")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp585 <- df %>%
    select(Year, 17:19) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP5-8.5`) %>%
    rename_with(~ gsub('SSP5-8.5 ', '', .x)) %>%
    mutate(Projection = "SSP5-8.5")   
  
  df <- bind_rows(df.historical, df.spp126, df.spp245, df.spp585)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection), alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 15, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Average Largest 5-day Cumulative Rainfall",
    subtitle = "Projected changes in average largest 5-day cumulative rainfall (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_cumulative_rainfall_changes_var3()

figure_save_draft_png(fig_ch1_projected_cumulative_rainfall_changes_var3(), style_SAR_CCDR, "../png/fig_ch1_projected_cumulative_rainfall_changes_var3.png", height=3.1, width=3.2)
```




```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_cumulative_rainfall_changes_var4 <- function() {
  
  # data
  df <- read_csv("../data/projected-average-largest-5-day-cumulative-rainfall.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection), alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left",
        sec.axis = dup_axis(
          breaks = df %>% filter(Year == max(Year)) %>% pull(Mean) %>% repel(gap=6)-historical_average.mean,
          labels = df %>% filter(Year == max(Year)) %>% pull(Projection)
        )) +
      annotate("text", x = 2004, y = 15, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme()
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Average Largest 5-day Cumulative Rainfall",
    subtitle = "Projected changes in average largest 5-day cumulative rainfall (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_cumulative_rainfall_changes_var4()

figure_save_draft_png(fig_ch1_projected_cumulative_rainfall_changes_var4(), style_SAR_CCDR, "../png/fig_ch1_projected_cumulative_rainfall_changes_var4.png", height=3.1, width=3.2)
```




```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_projected_cumulative_rainfall_changes_var5 <- function() {
  
  # data
  df <- read_csv("../data/projected-average-largest-5-day-cumulative-rainfall.csv") %>%
    rename(Year = Category)
  
  df.historical <- df %>%
    select(Year, 2:4) %>%
    filter(Year <= 2014) %>%
    rename(Mean = `Hist. Ref. Per., 1995-2014`) %>%
    rename_with(~ gsub('Historical ', '', .x)) %>%
    mutate(Projection = "Historical")
  
  df.spp119 <- df %>%
    select(Year, 5:7) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP1-1.9`) %>%
    rename_with(~ gsub('SSP1-1.9 ', '', .x)) %>%
    mutate(Projection = "SSP1-1.9")   

  df.spp245 <- df %>%
    select(Year, 11:13) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP2-4.5`) %>%
    rename_with(~ gsub('SSP2-4.5 ', '', .x)) %>%
    mutate(Projection = "SSP2-4.5")   
  
  df.spp370 <- df %>%
    select(Year, 14:16) %>%
    filter(Year >= 2014) %>%
    rename(Mean = `SSP3-7.0`) %>%
    rename_with(~ gsub('SSP3-7.0 ', '', .x)) %>%
    mutate(Projection = "SSP3-7.0")   
  
  df <- bind_rows(df.historical, df.spp119, df.spp245, df.spp370)
  
  historical_average <- df %>%
    filter(Projection == "Historical") %>%
    select(Mean, `10-90th Percentile Range (low)`, `10-90th Percentile Range (high)`)
  
  historical_average.mean <- mean(historical_average$Mean, na.rm=TRUE)
  historical_average.low <- mean(historical_average$`10-90th Percentile Range (low)`, na.rm=TRUE)
  historical_average.high <- mean(historical_average$`10-90th Percentile Range (high)`, na.rm=TRUE)
    
  # chart
  color_list <- c(
    style$colors$neutral.dark, 
    style$colors$blue, 
    style$colors$orange,  
    style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x=Year, y=Mean-historical_average.mean, color=Projection)) +
      geom_line(size=1.2) +
      geom_ribbon(aes(ymin=`10-90th Percentile Range (low)`-historical_average.mean, 
                      ymax=`10-90th Percentile Range (high)`-historical_average.mean, 
                      fill=Projection, color=Projection), alpha=0.1) +
      scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,3)) +
      scale_y_continuous(
        position="left"
      ) +
      # annotate("text", x = 2004, y = 15, label = "Hist. Ref. Per.\n1995-2014", size = 2, family = style$family, color=style$colors$text) +
      scale_fill_manual(values=color_list) + scale_color_manual(values=color_list) +
      geom_vline(xintercept = 2014, linetype = "dashed") +
      style$theme() +
      style$theme_legend("right")
    },
    aspect_ratio = 1,
    # title = "Projected Changes in Average Largest 5-day Cumulative Rainfall",
    subtitle = "Projected changes in average largest 5-day cumulative rainfall (mm)",
    source = "Source: World Bank (2022). https://climateknowledgeportal.worldbank.org/country/pakistan/climate-data-projections"
  )
}

fig_ch1_projected_cumulative_rainfall_changes_var5()

figure_save_draft_png(fig_ch1_projected_cumulative_rainfall_changes_var5(), style_SAR_CCDR, "../png/fig_ch1_projected_cumulative_rainfall_changes_var5.png", height=3.1, width=3.2)
```




&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

## National GHG Emission Profile 

Data source: https://www.climatewatchdata.org/ghg-emissions?breakBy=sector&chartType=area&end_year=2018&regions=PAK&sectors=total-including-lucf&start_year=1990

Source: CAIT

Country: Pakistan

Sector: Total including LUCF

Gases: All GHG

Show by: Sectors

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=5.5, out.width=800, dpi=200}
fig_ch1_GHG_by_sector_line <- function() {
  
  # data
  df <- read_csv("../data/ghg-emissions_by_sector.csv")
  df <- head(df, - 2)
  df <- df %>%
    gather(key="Year", value="Emissions", "2018":"1990") %>%
    select(Sector, Year, Emissions) %>%
    mutate(Year = as.numeric(Year))
  
  # chart
  color_list = c(
    "Agriculture" = style$colors$navy, 
    "Energy" = style$colors$blue,   
    "Industrial Processes" = style$colors$neutral,
    "Land-Use Change and Forestry" = style$colors$neutral.light,
    "Waste" = style$colors$neutral)
    
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = Year, y = Emissions, group = Sector, color = Sector)) +
        geom_line(size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,0)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = df %>% filter(Year == max(Year)) %>% pull(Emissions) %>% repel(gap=6),
            labels = df %>% filter(Year == max(Year)) %>% pull(Sector)
          )) +
        scale_color_manual(values = color_list, labels = unique(df$Sector)) +
        style$theme()
    },
    aspect_ratio = 1,
    # title = "Energy and agriculture sectors take up the largest portions of greenhouse gas emissions in Pakistan.",
    subtitle = "Historical Country Greenhouse Gas Emissions (MtCO2e), 1990-2018",
    source = "Source: Climate Watch Historical Country Greenhouse Gas Emissions Data (1990-2018)."
  )
}

fig_ch1_GHG_by_sector_line()

figure_save_draft_png(fig_ch1_GHG_by_sector_line(), style_SAR_CCDR, "../png/fig_ch1_GHG_by_sector_line.png", height=5.1, width=5.5)
```


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=5.5, out.width=800, dpi=200}
fig_ch1_GHG_by_sector_area <- function() {
  
  # data
  df <- read_csv("../data/ghg-emissions_by_sector.csv")
  df <- head(df, - 2)
  df <- df %>%
    gather(key="Year", value="Emissions", "2018":"1990") %>%
    select(Sector, Year, Emissions) %>%
    mutate(Year = as.numeric(Year)) %>%
    group_by(Year) %>%
    mutate(percentage = 100 *Emissions/sum(Emissions, na.rm=TRUE))
  
  ordered_sector <- df %>%
    filter(Year == 2018) %>%
    arrange(desc(percentage)) %>% pull(Sector)
  
  # chart
  color_list = c(
    "Energy" = style$colors$blue,   
    "Agriculture" = style$colors$orange,  
    "Industrial Processes" = style$colors$navy, 
    "Waste" = style$colors$purple,
    "Land-Use Change and Forestry" = style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = Year, y = Emissions, fill = factor(Sector, levels=ordered_sector))) +
        geom_area() +
        scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,0)) +
        scale_y_continuous(
          position="left"
        ) +
        scale_fill_manual(values = color_list) +
        style$theme() +
        style$theme_legend("right")
    },
    aspect_ratio = 1,
    # title = "Greenhouse gas emissions by sectors",
    subtitle = "Historical GHG emissions (MtCO2e)",
    source = "Source: Climate Watch Historical Country Greenhouse Gas Emissions Data (1990-2018)."
  )
}

fig_ch1_GHG_by_sector_area()

figure_save_draft_png(fig_ch1_GHG_by_sector_area(), style_SAR_CCDR, "../png/fig_ch1_GHG_by_sector_area.png", height=3.1, width=5.5)
```


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_GHG_by_sector_pie <- function() {
  
  # data
  df <- read_csv("../data/ghg-emissions_by_sector.csv")
  df <- head(df, - 2)
  df <- df %>%
    gather(key="Year", value="Emissions", "2018":"1990") %>%
    select(Sector, Year, Emissions) %>%
    mutate(Year = as.numeric(Year)) %>%
    group_by(Year) %>%
    mutate(percentage = 100 *Emissions/sum(Emissions, na.rm=TRUE)) %>%
    filter(Year == 2018) %>%
    arrange(desc(percentage))
  
  df$ymax <- cumsum(df$percentage)
  df$ymin <- c(0, head(df$ymax, n=-1))
  df$labelPosition <- (df$ymax + df$ymin) / 2
  df$label <- paste0(df$Sector, "\n", round(df$percentage,1), "%")
  df$label <- c("Energy\n48.1%", "Agriculture\n42.5%", "Industrial\nProcesses\n5.7%", "Waste\n2.1%", "Land-Use Change and Forestry\n1.6%")
  df$vjust <- c(0.5, 0.5, 0.8, 0.9, 0.0)
  
  # chart
  color_list = c(
    "Energy" = style$colors$blue,   
    "Agriculture" = style$colors$orange,  
    "Industrial Processes" = style$colors$navy, 
    "Waste" = style$colors$purple,
    "Land-Use Change and Forestry" = style$colors$red)
    
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Sector)) +
      geom_rect(color = "white", size=1) +
      geom_label(x=4.5, aes(y=labelPosition, label=label, vjust=vjust), size=2.5, family = style$family, label.size = NA, fill = NA) +
      coord_polar(theta="y") +
      xlim(c(2, 4.5)) +
      scale_fill_manual(values = color_list) +
      # theme_void() +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank(),
            plot.margin = margin(1,1,-15,1, unit = "mm"))
    },
    aspect_ratio = 1,
    # title = "Emissions are primarily from energy and agriculture, comprising 48% and 42% respectively, followed by Industrial Processes (6%), Waste (2.1%), and Land-Use Change and Forestry (1.6%).",
    subtitle = "GHG emissions (MtCO2e), 2018",
    source = "Source: Climate Watch Historical Country Greenhouse Gas Emissions Data (2018)."
  )
}

fig_ch1_GHG_by_sector_pie()

figure_save_draft_png(fig_ch1_GHG_by_sector_pie(), style_SAR_CCDR, "../png/fig_ch1_GHG_by_sector_pie.png", height=5.1, width=5.5)
```



Data source: 

* https://www.climatewatchdata.org/ghg-emissions?breakBy=sector&chartType=area&end_year=2018&regions=PAK&sectors=total-including-lucf&start_year=1990


* https://www.climatewatchdata.org/ghg-emissions?breakBy=sector&chartType=area&end_year=2018&regions=PAK&sectors=building%2Celectricity-heat%2Cfugitive-emissions%2Cmanufacturing-construction%2Cother-fuel-combustion%2Ctransportation&start_year=1990

Source: CAIT

Country: Pakistan

Sector: Total including LUCF, Sub-catagories of Energy

Gases: All GHG

Show by: Sectors


```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=5.5, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_GHG_by_sector_pie_var1 <- function() {
  
  # data
  df <- read_csv("../data/ghg-emissions_by_sector.csv")
  df <- head(df, - 2)
  df <- df %>%
    gather(key="Year", value="Emissions", "2018":"1990") %>%
    select(Sector, Year, Emissions) %>%
    mutate(Year = as.numeric(Year)) %>%
    group_by(Year) %>%
    mutate(percentage = 100 *Emissions/sum(Emissions, na.rm=TRUE)) %>%
    filter(Year == 2018) %>%
    arrange(desc(percentage))
  
  df$ymax <- cumsum(df$percentage)
  df$ymin <- c(0, head(df$ymax, n=-1))
  df$labelPosition <- (df$ymax + df$ymin) / 2
  df$label <- paste0(df$Sector, "\n", round(df$percentage,1), "%")
  df$label <- c("Energy\n48.1% ", "Agriculture\n42.5%             ", "Industrial\nProcesses\n5.7%", "Waste\n2.1%", "Land-Use Change\nand Forestry\n1.6%")
  df$vjust <- c(0.5, 0.5, 0.9, 0.9, -0.2)
  df$hjust <- c(3, -1.2, 0.5, 0.5, 0.5)
  
  energy_percentage <- df$percentage[1]
  df_energy <- read_csv("../data/ghg-emissions_by_catagory_in_energy.csv")
  df_energy <- head(df_energy, - 2)
  df_energy <- df_energy %>%
    gather(key="Year", value="Emissions", "2018":"1990") %>%
    select(Sector, Year, Emissions) %>%
    mutate(Year = as.numeric(Year)) %>%
    mutate(Emissions = as.numeric(Emissions)) %>%
    group_by(Year) %>%
    mutate(percentage = energy_percentage*Emissions/sum(Emissions, na.rm=TRUE)) %>%
    filter(Year == 2018) %>%
    arrange(desc(percentage))
  
  df_energy$ymax <- cumsum(df_energy$percentage)
  df_energy$ymin <- c(0, head(df_energy$ymax, n=-1))
  df_energy$labelPosition <- (df_energy$ymax + df_energy$ymin) / 2
  df_energy$label <- paste0(df_energy$Sector, "\n", round(df_energy$percentage,1), "%")
  df_energy$angle <- ifelse(df_energy$labelPosition/max(df_energy$ymax)*360*energy_percentage/100 < 180,
                              90 - df_energy$labelPosition/max(df_energy$ymax)*360*energy_percentage/100,
                              df_energy$labelPosition/max(df_energy$ymax)*360*energy_percentage/100*-1 + 270)
  df_energy$hjust <- c(0,0,0,0,0,0)
  df_energy$alpha <- seq(0.7, 0.2, length = 6)
  
  
  # chart
  color_list = c(
    "Energy" = style$colors$blue,
    "Agriculture" = style$colors$orange,
    "Industrial Processes" = style$colors$navy,
    "Waste" = style$colors$purple,
    "Land-Use Change and Forestry" = style$colors$red,
    "Electricity/Heat" = "#50B1E2",
    "Transportation" = "#50B1E2",
    "Manufacturing/Construction" = "#50B1E2",
    "Building" = "#50B1E2",
    "Fugitive Emissions" = "#50B1E2",
    "Other Fuel Combustion" = "#50B1E2")
    
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot() +
      geom_rect(data=df, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Sector), color = "white", size=1) +
      geom_rect(data=df_energy, aes(ymax=ymax, ymin=ymin, xmax=4.5, xmin=4, fill=Sector, alpha=alpha), color = "white", size=1) +
      geom_text(data=df, x=4.5, aes(y=labelPosition, label=label, vjust=vjust, hjust=hjust), size=2.5, family = style$family, lineheight = 1) +
      geom_text(data=df_energy, x=4.6, aes(y = labelPosition, label = label, angle=angle, hjust=hjust, family=style$family), size=2, lineheight = 1, show.legend = F) + 
      coord_polar(theta="y") +
      xlim(c(2, 5.4)) +
      scale_fill_manual(values = color_list) +
      # theme_void() +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank(),
            plot.margin = margin(-20,1,-10,1, unit = "mm"))
    },
    aspect_ratio = 1,
    # title = "Emissions are primarily from energy and agriculture, comprising 48% and 42% respectively, followed by Industrial Processes (6%), Waste (2.1%), and Land-Use Change and Forestry (1.6%).",
    subtitle = "GHG emissions (MtCO2e), 2018",
    source = "Source: Climate Watch Historical Country Greenhouse Gas Emissions Data (2018)."
  )
}

fig_ch1_GHG_by_sector_pie_var1()

figure_save_draft_png(fig_ch1_GHG_by_sector_pie_var1(), style_SAR_CCDR, "../png/fig_ch1_GHG_by_sector_pie_var1.png", height=5.5, width=5.5)
```





Data source: https://www.climatewatchdata.org/ghg-emissions?breakBy=gas&chartType=line&end_year=2018&gases=all-ghg&regions=PAK&sectors=total-including-lucf&start_year=1990

Source: CAIT

Country: Pakistan

Sector: Total including LUCF

Gases: All GHG

Show by: Gases

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=5.5, out.width=800, dpi=200}
fig_ch1_GHG_by_gas_area <- function() {
  
  # data
  df <- read_csv("../data/ghg-emissions_by_gases.csv")
  df <- head(df, - 2)
  df <- df %>%
    gather(key="Year", value="Emissions", "2018":"1990") %>%
    select(Gas, Year, Emissions) %>%
    mutate(Year = as.numeric(Year)) %>%
    group_by(Year) %>%
    mutate(percentage = 100 *Emissions/sum(Emissions, na.rm=TRUE))
  
  ordered_gases <- df %>%
    filter(Year == 2018) %>%
    arrange(desc(percentage)) %>% pull(Gas)
  
  # chart
  color_list = c(
    "CO2" = style$colors$blue,   
    "CH4" = style$colors$orange,  
    "N2O" = style$colors$purple,
    "F-Gas" = style$colors$red)
  
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = Year, y = Emissions, fill = factor(Gas, levels=ordered_gases))) +
        geom_area() +
        scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,0)) +
        scale_y_continuous(
          position="left"
        ) +
        scale_fill_manual(values = color_list) +
        style$theme() +
        style$theme_legend("right")
    },
    aspect_ratio = 1,
    # title = "Greenhouse gas emissions by gases",
    subtitle = "Historical GHG emissions (MtCO2e)",
    source = "Source: Climate Watch Historical Country Greenhouse Gas Emissions Data (1990-2018)."
  )
}

fig_ch1_GHG_by_gas_area()

figure_save_draft_png(fig_ch1_GHG_by_gas_area(), style_SAR_CCDR, "../png/fig_ch1_GHG_by_gas_area.png", height=3.1, width=5.5)
```



```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=3.2, out.width=800, dpi=200}

fig_ch1_GHG_by_gas_pie <- function() {
  
  # data
  df <- read_csv("../data/ghg-emissions_by_gases.csv")
  df <- head(df, - 2)
  df <- df %>%
    gather(key="Year", value="Emissions", "2018":"1990") %>%
    select(Gas, Year, Emissions) %>%
    mutate(Year = as.numeric(Year)) %>%
    group_by(Year) %>%
    mutate(percentage = 100 *Emissions/sum(Emissions, na.rm=TRUE)) %>%
    filter(Year == 2018) %>%
    arrange(desc(percentage))
  
  df$ymax <- cumsum(df$percentage)
  df$ymin <- c(0, head(df$ymax, n=-1))
  df$labelPosition <- (df$ymax + df$ymin) / 2
  df$label <- paste0(df$Gas, "\n", round(df$percentage,1), "%")
  # df$label <- c("Energy\n48.1%", "Agriculture\n42.5%", "Industrial\nProcesses\n5.7%", "Waste\n2.1%", "Land-Use Change and Forestry\n1.6%")
  df$vjust <- c(0.5, 0.5, 0.5, 0.5)
  
  # chart
  color_list = c(
    "CO2" = style$colors$blue,   
    "CH4" = style$colors$orange,  
    "N2O" = style$colors$purple,
    "F-Gas" = style$colors$red)
    
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Gas)) +
      geom_rect(color = "white", size=1) +
      geom_label(x=4.3, aes(y=labelPosition, label=label, vjust=vjust), size=2.5, family = style$family, label.size = NA, fill = NA) +
      coord_polar(theta="y") +
      xlim(c(2, 4.1)) +
      scale_fill_manual(values = color_list) +
      style$theme() +
      theme(legend.position = "none",
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_blank(),
            axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.text.y = element_blank(),
            plot.margin = margin(1,1,-5,1, unit = "mm"))
    },
    aspect_ratio = 1,
    # title = "Greenhouse gas emissions by gases",
    subtitle = "GHG emissions (MtCO2e), 2018",
    source = "Source: Climate Watch Historical Country Greenhouse Gas Emissions Data (2018)."
  )
}

fig_ch1_GHG_by_gas_pie()

figure_save_draft_png(fig_ch1_GHG_by_gas_pie(), style_SAR_CCDR, "../png/fig_ch1_GHG_by_gas_pie.png", height=3.1, width=3.2)
```



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

## Vulnerability score

Data source: https://gain.nd.edu/our-work/country-index/download-data/

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=4.1, fig.width=4.1, out.width=800, dpi=200}
library(ggradar)
library(showtext)

fig_ch1_vulnerability <- function() {
  
  # data
  df <- read_csv("../data/vulnerability.csv")

  # add regions and income levels
  df <- df %>%
    rename(iso3c = ISO3) %>%
    left_join(wbgref$countries$regions, by="iso3c") %>%
    left_join(wbgref$countries$incomegroups, by="iso3c")
  
  # calculate aggregates by regions
  region_aggregates <- df %>%
    group_by(region_iso3c) %>% summarize(ecosystems = mean(ecosystems, na.rm=TRUE),
                                         food = mean(food, na.rm=TRUE),
                                         health = mean(health, na.rm=TRUE),
                                         habitat = mean(habitat, na.rm=TRUE),
                                         infrastructure = mean(infrastructure, na.rm=TRUE),
                                         water = mean(water, na.rm=TRUE)) %>%
    rename(iso3c = region_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$regions$labels), Name = wbgref$regions$labels), by="iso3c")
    
  # calculate aggregates by income levels
  income_level_aggregates <- df %>%
    group_by(income_level_iso3c) %>% summarize(ecosystems = mean(ecosystems, na.rm=TRUE),
                                         food = mean(food, na.rm=TRUE),
                                         health = mean(health, na.rm=TRUE),
                                         habitat = mean(habitat, na.rm=TRUE),
                                         infrastructure = mean(infrastructure, na.rm=TRUE),
                                         water = mean(water, na.rm=TRUE)) %>%
    rename(iso3c = income_level_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$incomes$labels), Name = wbgref$incomes$labels), by="iso3c")
  
  # merge and select
  df <- df %>%
    bind_rows(region_aggregates, income_level_aggregates) %>%
    filter(iso3c == "PAK" | iso3c == "LMC" | iso3c == "SAS") %>%
    select(Name, ecosystems, food, health, habitat, infrastructure, water)
  
  # rescale
  min <- 0.3
  max <- 0.9
  min_max_norm <- function(x) {
    (x - min) / (max - min)
  }
  df <- df %>%
    mutate(ecosystems = min_max_norm(ecosystems)) %>%
    mutate(food = min_max_norm(food)) %>%
    mutate(health = min_max_norm(health)) %>%
    mutate(habitat = min_max_norm(habitat)) %>%
    mutate(infrastructure = min_max_norm(infrastructure)) %>%
    mutate(water = min_max_norm(water))
  
  # chart
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggradar(
        df,
        background.circle.colour = "white",
        font.radar = style$family,
        values.radar = c(min, (min+max)/2, max),
        grid.min = 0, grid.mid = 0.5, grid.max = 1,
        grid.label.size = 3,  # Affects the grid annotations (0%, 50%, etc.)
        axis.label.size = 3, # Afftects the names of the variables
        group.point.size = 3   # Simply the size of the point 
      ) +
      style$theme() +
      theme(
        line = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.position = c(1, 0),  
        legend.justification = c(1, 0),
        legend.text = element_text(size = 7, family = style$family),
        legend.key = element_rect(fill = NA, color = NA),
        legend.background = element_blank()
      ) +
      scale_color_manual(values = c(
        "Lower middle income" = style$colors$spot.secondary, 
        "South Asia" = style$colors$spot.secondary.light,
        "Pakistan" = style$colors$spot.primary
      ))
    },
    aspect_ratio = 1,
    title = "Pakistan's vulnerability in six life-supporting sectors.",
    subtitle = "Vulnerability scores (0-1 lower is better), 2019",
    note = "Note: Vulnerability measures a country's exposure, sensitivity and ability to adapt to the negative impact of climate change.",
    source = "Source: The Notre Dame-Global Adaptation Index (ND-GAIN) Country Index."
  )
}

fig_ch1_vulnerability()

figure_save_draft_png(fig_ch1_vulnerability(), style_SAR_CCDR, "../png/fig_ch1_vulnerability.png", height=4.1, width=4.1)
```





&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

## Readiness score

Data source: https://gain.nd.edu/our-work/country-index/download-data/

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=4.1, fig.width=4.1, out.width=800, dpi=200}
library(ggradar)
library(showtext)

fig_ch1_readiness <- function() {
  
  # data
  df <- read_csv("../data/readiness.csv")

  # add regions and income levels
  df <- df %>%
    rename(iso3c = ISO3) %>%
    left_join(wbgref$countries$regions, by="iso3c") %>%
    left_join(wbgref$countries$incomegroups, by="iso3c")
  
  # calculate aggregates by regions
  region_aggregates <- df %>%
    group_by(region_iso3c) %>% summarize(economic = mean(economic, na.rm=TRUE),
                                         governance = mean(governance, na.rm=TRUE),
                                         social = mean(social, na.rm=TRUE)) %>%
    rename(iso3c = region_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$regions$labels), Name = wbgref$regions$labels), by="iso3c")
    
  # calculate aggregates by income levels
  income_level_aggregates <- df %>%
    group_by(income_level_iso3c) %>% summarize(economic = mean(economic, na.rm=TRUE),
                                         governance = mean(governance, na.rm=TRUE),
                                         social = mean(social, na.rm=TRUE)) %>%
    rename(iso3c = income_level_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$incomes$labels), Name = wbgref$incomes$labels), by="iso3c")
  
  # merge and select
  df <- df %>%
    bind_rows(region_aggregates, income_level_aggregates) %>%
    filter(iso3c == "PAK" | iso3c == "LMC" | iso3c == "SAS") %>%
    select(Name, economic, governance, social)
  
  # rescale
  min <- 0.25
  max <- 0.45
  min_max_norm <- function(x) {
    (x - min) / (max - min)
  }
  df <- df %>%
    mutate(economic = min_max_norm(economic)) %>%
    mutate(governance = min_max_norm(governance)) %>%
    mutate(social = min_max_norm(social))
  
  # chart
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggradar(
        df,
        background.circle.colour = "white",
        font.radar = style$family,
        values.radar = c(min, (min+max)/2, max),
        grid.min = 0, grid.mid = 0.5, grid.max = 1,
        grid.label.size = 3,  # Affects the grid annotations (0%, 50%, etc.)
        axis.label.size = 3, # Afftects the names of the variables
        group.point.size = 3   # Simply the size of the point 
      ) +
      style$theme() +
      theme(
        line = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.position = c(1, 0),  
        legend.justification = c(1, 0),
        legend.text = element_text(size = 7, family = style$family),
        legend.key = element_rect(fill = NA, color = NA),
        legend.background = element_blank()
      ) +
      scale_color_manual(values = c(
        "Lower middle income" = style$colors$spot.secondary, 
        "South Asia" = style$colors$spot.secondary.light,
        "Pakistan" = style$colors$spot.primary
      ))
    },
    aspect_ratio = 1,
    title = "Pakistan's readiness in economic opportunity, governance, and social structures.",
    subtitle = "Readiness scores (0-1 higher is better), 2019",
    note = "Note: Readiness measures a country’s ability to leverage investments and convert them to adaptation actions.",
    source = "Source: The Notre Dame-Global Adaptation Index (ND-GAIN) Country Index."
  )
}

fig_ch1_readiness()

figure_save_draft_png(fig_ch1_readiness(), style_SAR_CCDR, "../png/fig_ch1_readiness.png", height=4.1, width=4.1)

```





```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=4.1, fig.width=8.2, out.width=800, dpi=200}

library(zoo)
library(ggradar)
library(showtext)

fig_ch1_vulnerability_readiness <- function() {

  # vulnerability data
  df <- read_csv("../data/vulnerability.csv")

  # add regions and income levels
  df <- df %>%
    rename(iso3c = ISO3) %>%
    left_join(wbgref$countries$regions, by="iso3c") %>%
    left_join(wbgref$countries$incomegroups, by="iso3c")
  
  # calculate aggregates by regions
  region_aggregates <- df %>%
    group_by(region_iso3c) %>% summarize(ecosystems = mean(ecosystems, na.rm=TRUE),
                                         food = mean(food, na.rm=TRUE),
                                         health = mean(health, na.rm=TRUE),
                                         habitat = mean(habitat, na.rm=TRUE),
                                         infrastructure = mean(infrastructure, na.rm=TRUE),
                                         water = mean(water, na.rm=TRUE)) %>%
    rename(iso3c = region_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$regions$labels), Name = wbgref$regions$labels), by="iso3c")
    
  # calculate aggregates by income levels
  income_level_aggregates <- df %>%
    group_by(income_level_iso3c) %>% summarize(ecosystems = mean(ecosystems, na.rm=TRUE),
                                         food = mean(food, na.rm=TRUE),
                                         health = mean(health, na.rm=TRUE),
                                         habitat = mean(habitat, na.rm=TRUE),
                                         infrastructure = mean(infrastructure, na.rm=TRUE),
                                         water = mean(water, na.rm=TRUE)) %>%
    rename(iso3c = income_level_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$incomes$labels), Name = wbgref$incomes$labels), by="iso3c")
  
  # merge and select
  df.vulnerability <- df %>%
    bind_rows(region_aggregates, income_level_aggregates) %>%
    filter(iso3c == "PAK" | iso3c == "LMC" | iso3c == "SAS") %>%
    select(Name, ecosystems, food, health, habitat, infrastructure, water)
  
  # rescale
  vulnerability.min <- 0.3
  vulnerability.max <- 0.9
  vulnerability.min_max_norm <- function(x) {
    (x - vulnerability.min) / (vulnerability.max - vulnerability.min)
  }
  df.vulnerability <- df.vulnerability %>%
    mutate(ecosystems = vulnerability.min_max_norm(ecosystems)) %>%
    mutate(food = vulnerability.min_max_norm(food)) %>%
    mutate(health = vulnerability.min_max_norm(health)) %>%
    mutate(habitat = vulnerability.min_max_norm(habitat)) %>%
    mutate(infrastructure = vulnerability.min_max_norm(infrastructure)) %>%
    mutate(water = vulnerability.min_max_norm(water))
  
  # readiness data
  df <- read_csv("../data/readiness.csv")

  # add regions and income levels
  df <- df %>%
    rename(iso3c = ISO3) %>%
    left_join(wbgref$countries$regions, by="iso3c") %>%
    left_join(wbgref$countries$incomegroups, by="iso3c")
  
  # calculate aggregates by regions
  region_aggregates <- df %>%
    group_by(region_iso3c) %>% summarize(economic = mean(economic, na.rm=TRUE),
                                         governance = mean(governance, na.rm=TRUE),
                                         social = mean(social, na.rm=TRUE)) %>%
    rename(iso3c = region_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$regions$labels), Name = wbgref$regions$labels), by="iso3c")
    
  # calculate aggregates by income levels
  income_level_aggregates <- df %>%
    group_by(income_level_iso3c) %>% summarize(economic = mean(economic, na.rm=TRUE),
                                         governance = mean(governance, na.rm=TRUE),
                                         social = mean(social, na.rm=TRUE)) %>%
    rename(iso3c = income_level_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$incomes$labels), Name = wbgref$incomes$labels), by="iso3c")
  
  # merge and select
  df.readiness <- df %>%
    bind_rows(region_aggregates, income_level_aggregates) %>%
    filter(iso3c == "PAK" | iso3c == "LMC" | iso3c == "SAS") %>%
    select(Name, economic, governance, social)
  
  # rescale
  readiness.min <- 0.25
  readiness.max <- 0.45
  readiness.min_max_norm <- function(x) {
    (x - readiness.min) / (readiness.max - readiness.min)
  }
  df.readiness <- df.readiness %>%
    mutate(economic = readiness.min_max_norm(economic)) %>%
    mutate(governance = readiness.min_max_norm(governance)) %>%
    mutate(social = readiness.min_max_norm(social))
  
  df <- merge(x = df.vulnerability, y = df.readiness, by = "Name", all = TRUE)
  
  # chart
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      
      df.vulnerability <- df %>%
        select(Name, ecosystems, food, health, habitat, infrastructure, water)
      
      p.vulnerability <- ggradar(
          df.vulnerability,
          background.circle.colour = "white",
          font.radar = style$family,
          values.radar = c(vulnerability.min, (vulnerability.min+vulnerability.max)/2, vulnerability.max),
          grid.min = 0, grid.mid = 0.5, grid.max = 1,
          grid.label.size = 3,  # Affects the grid annotations (0%, 50%, etc.)
          axis.label.size = 3, # Afftects the names of the variables
          group.point.size = 3   # Simply the size of the point 
        ) +
        style$theme() +
        theme(
          plot.subtitle=element_text(hjust=0.5),
          line = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_blank(),
          legend.position = c(1, 0),  
          legend.justification = c(1, 0),
          legend.text = element_text(size = 7, family = style$family),
          legend.key = element_rect(fill = NA, color = NA),
          legend.background = element_blank()
        ) +
        scale_color_manual(values = c(
          "Lower middle income" = style$colors$spot.secondary, 
          "South Asia" = style$colors$spot.secondary.light,
          "Pakistan" = style$colors$spot.primary
        )) +
        labs(subtitle = "Vulnerability scores (0-1 lower is better), 2019")
      
      df.readiness <- df %>%
        select(Name, economic, governance, social)

      p.readiness <- ggradar(
          df.readiness,
          font.radar = style$family,
          background.circle.colour = "white",
          values.radar = c(readiness.min, (readiness.min+readiness.max)/2, readiness.max),
          grid.min = 0, grid.mid = 0.5, grid.max = 1,
          grid.label.size = 3,  # Affects the grid annotations (0%, 50%, etc.)
          axis.label.size = 3, # Afftects the names of the variables
          group.point.size = 3   # Simply the size of the point 
        ) +
        style$theme() +
        theme(
          plot.subtitle=element_text(hjust=0.5),
          line = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_blank(),
          legend.position = c(1, 0),  
          legend.justification = c(1, 0),
          legend.text = element_text(size = 7, family = style$family),
          legend.key = element_rect(fill = NA, color = NA),
          legend.background = element_blank()
        ) +
        scale_color_manual(values = c(
          "Lower middle income" = style$colors$spot.secondary, 
          "South Asia" = style$colors$spot.secondary.light,
          "Pakistan" = style$colors$spot.primary
        )) +
        labs(subtitle = "Readiness scores (0-1 higher is better), 2019")
      
      
      pt.vulnerability <- ggplotGrob(p.vulnerability)
      pt.readiness <- ggplotGrob(p.readiness)
  
      chart <- gtable_row(
        "chart", 
        list(pt.vulnerability, zeroGrob(), pt.readiness), 
        height = unit(1, "null"), 
        widths = unit.c(unit(1, "null"), unit(0.3, "in"), unit(1, "null"))
        )
      chart$theme <- style$theme()
      chart
      
    },
    aspect_ratio = 1,
    title = "Pakistan's climate vulnerability and adaptation readiness",
    note = "Note: Vulnerability measures a country's exposure, sensitivity and ability to adapt to the negative impact of climate change while Readiness measures a country’s ability to leverage investments and convert them to adaptation actions.",
    source = "Source: The Notre Dame-Global Adaptation Index (ND-GAIN) Country Index."
  )
}

fig_ch1_vulnerability_readiness()

figure_save_draft_png(fig_ch1_vulnerability_readiness(), style_SAR_CCDR, "../png/fig_ch1_vulnerability_readiness.png", height=4.1, width=8.2)

```





&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

## ND-GAIN

Data source: https://gain.nd.edu/our-work/country-index/download-data/

```{r, echo=FALSE, message=FALSE, warning = FALSE, fig.height=3.1, fig.width=5.5, out.width=800, dpi=200}

fig_ch1_nd_gain <- function() {
  
  # data
  df <- read_csv("../data/ND-gain.csv")

  # add regions and income levels
  df <- df %>%
    rename(iso3c = ISO3) %>%
    left_join(wbgref$countries$regions, by="iso3c") %>%
    left_join(wbgref$countries$incomegroups, by="iso3c")

  # calculate aggregates by regions
  region_aggregates <- df %>%
    group_by(region_iso3c) %>% summarise(across(where(is.double), ~ mean(.x, na.rm = TRUE))) %>%
    rename(iso3c = region_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$regions$labels), Name = wbgref$regions$labels), by="iso3c")
  
  # calculate aggregates by income levels
  income_level_aggregates <- df %>%
    group_by(income_level_iso3c) %>% summarise(across(where(is.double), ~ mean(.x, na.rm = TRUE))) %>%
    rename(iso3c = income_level_iso3c) %>% 
    left_join(data.frame(iso3c = names(wbgref$incomes$labels), Name = wbgref$incomes$labels), by="iso3c")
  
  # merge and select
  df <- df %>%
    bind_rows(region_aggregates, income_level_aggregates) %>%
    filter(iso3c == "PAK" | iso3c == "LMC" | iso3c == "SAS") %>%
    select(-c(region_iso3c, income_level_iso3c)) %>%
    gather(key="Year", value="Gain", "1995":"2019") %>%
    select(iso3c, Name, Year, Gain) %>%
    mutate(Year = as.numeric(Year))
  
  # chart
  figure(
    data = df,
    plot = function(df, style = style_SAR_CCDR()) {
      ggplot(df, aes(x = Year, y = Gain, group = rev(iso3c), color = iso3c)) +
        geom_line(size = style$linesize) +
        scale_x_continuous(breaks = bracketed_breaks(df$Year), expand=c(0,0)) +
        scale_y_continuous(
          position="left",
          sec.axis = dup_axis(
            breaks = df %>% filter(Year == max(Year)) %>% pull(Gain) %>% repel(gap=6),
            labels = df %>% filter(Year == max(Year)) %>% pull(Name)
          )) +
        scale_color_manual(values = c(
          "LMC" = style$colors$spot.secondary.light, 
          "SAS" = style$colors$spot.secondary.light,
          "PAK" = style$colors$spot.primary)) +
        style$theme()
    },
    aspect_ratio = 1,
    title = "Pakistan's ND-GAIN dropped by nearly 10% points in 2014.",
    subtitle = "ND-GAIN Country Index (0-100 higher is better), 1995-2019",
    note = "Note: The ND-GAIN Country Index summarizes a country's vulnerability to climate change and other global challenges in combination with its readiness to improve resilience.",
    source = "Source: The Notre Dame-Global Adaptation Index (ND-GAIN) Country Index."
  )
}

fig_ch1_nd_gain()

figure_save_draft_png(fig_ch1_nd_gain(), style_SAR_CCDR, "../png/fig_ch1_nd_gain.png", height=3.1, width=5.5)
```








  
